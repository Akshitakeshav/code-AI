<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Website Builder - Create Websites with AI</title>
    <meta name="description" content="Generate, preview, and learn to build websites with AI-powered assistance.">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- Terminal libraries -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css">
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Cursor/VS Code inspired colors
                        dark: '#1e1e1e',
                        darker: '#181818',
                        darkest: '#121212',
                        darkGray: '#252526',
                        panelBg: '#1f1f1f',
                        sidebarBg: '#181818',
                        activityBar: '#181818',
                        titleBar: '#1f1f1f',
                        statusBar: '#007acc',
                        border: '#3c3c3c',
                        borderLight: '#4d4d4d',
                        electricBlue: '#0078d4',
                        softPurple: '#c586c0',
                        accent: '#0078d4',
                        accentHover: '#1c8cd5',
                        lightGray: '#cccccc',
                        mutedGray: '#858585',
                        textMuted: '#6e7681',
                        success: '#3fb950',
                        warning: '#d29922',
                        error: '#f85149',
                    }
                }
            }
        }
    </script>

    <!-- Monaco Editor -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* ========================================
           CURSOR/TRAE IDE STYLE - BASE STYLES
           ======================================== */

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #1e1e1e;
            color: #cccccc;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        .font-mono {
            font-family: 'JetBrains Mono', 'Consolas', 'Monaco', monospace;
        }

        /* ========================================
           ACTIVITY BAR (Left Icon Bar)
           ======================================== */

        .activity-bar {
            width: 48px;
            background: #181818;
            border-right: 1px solid #2d2d2d;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 8px;
            flex-shrink: 0;
        }

        .activity-bar-item {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            color: #858585;
            transition: color 0.15s ease;
        }

        .activity-bar-item:hover {
            color: #ffffff;
        }

        .activity-bar-item.active {
            color: #ffffff;
        }

        .activity-bar-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 2px;
            height: 24px;
            background: #0078d4;
            border-radius: 0 2px 2px 0;
        }

        .activity-bar-item svg {
            width: 24px;
            height: 24px;
        }

        .activity-bar-bottom {
            margin-top: auto;
            padding-bottom: 8px;
        }

        /* ========================================
           STATUS BAR (Bottom Bar)
           ======================================== */

        .status-bar {
            height: 22px;
            background: #007acc;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 10px;
            font-size: 12px;
            color: #ffffff;
            flex-shrink: 0;
        }

        .status-bar-left,
        .status-bar-right {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .status-bar-item {
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            padding: 0 6px;
            height: 22px;
            transition: background 0.15s ease;
        }

        .status-bar-item:hover {
            background: rgba(255, 255, 255, 0.12);
        }

        .status-bar-item svg {
            width: 14px;
            height: 14px;
        }

        /* ========================================
           TITLE BAR / HEADER
           ======================================== */

        .title-bar {
            height: 35px;
            background: #1f1f1f;
            border-bottom: 1px solid #2d2d2d;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 12px;
            -webkit-app-region: drag;
        }

        .title-bar-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .title-bar-center {
            flex: 1;
            display: flex;
            justify-content: center;
        }

        .title-bar-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .command-palette-trigger {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 12px;
            background: #3c3c3c;
            border: 1px solid #4d4d4d;
            border-radius: 6px;
            color: #858585;
            font-size: 12px;
            cursor: pointer;
            min-width: 200px;
            transition: all 0.15s ease;
        }

        .command-palette-trigger:hover {
            background: #45454d;
            border-color: #5a5a5a;
            color: #cccccc;
        }

        .command-palette-trigger kbd {
            background: #2d2d2d;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-family: inherit;
            color: #858585;
        }

        /* ========================================
           SIDEBAR (File Explorer)
           ======================================== */

        .sidebar {
            width: 240px;
            background: #181818;
            border-right: 1px solid #2d2d2d;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            overflow: hidden;
        }

        .sidebar-header {
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px 0 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #bbbbbb;
            background: #181818;
        }

        .sidebar-header-actions {
            display: flex;
            gap: 4px;
        }

        .sidebar-header-actions button {
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            color: #858585;
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .sidebar-header-actions button:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 4px 0;
        }

        .file-tree-item {
            display: flex;
            align-items: center;
            padding: 4px 8px 4px 20px;
            cursor: pointer;
            font-size: 13px;
            color: #cccccc;
            position: relative;
            transition: background 0.1s ease;
        }

        .file-tree-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .file-tree-item.active {
            background: rgba(0, 120, 212, 0.2);
        }

        .file-tree-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #0078d4;
        }

        .file-tree-icon {
            width: 16px;
            height: 16px;
            margin-right: 6px;
            flex-shrink: 0;
        }

        .file-tree-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .file-tree-actions {
            display: none;
            gap: 2px;
        }

        .file-tree-item:hover .file-tree-actions {
            display: flex;
        }

        .file-tree-action-btn {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            color: #858585;
            background: transparent;
            border: none;
            cursor: pointer;
        }

        .file-tree-action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }

        .folder-item {
            padding-left: 8px;
        }

        .folder-item .folder-arrow {
            width: 16px;
            height: 16px;
            margin-right: 2px;
            color: #858585;
            transition: transform 0.1s ease;
        }

        .folder-item.open .folder-arrow {
            transform: rotate(90deg);
        }

        /* ========================================
           EDITOR TABS
           ======================================== */

        .editor-tabs {
            display: flex;
            background: #181818;
            border-bottom: 1px solid #2d2d2d;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .editor-tabs::-webkit-scrollbar {
            display: none;
        }

        .editor-tab {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            font-size: 13px;
            color: #858585;
            background: transparent;
            border: none;
            border-right: 1px solid #2d2d2d;
            cursor: pointer;
            position: relative;
            transition: all 0.1s ease;
            white-space: nowrap;
        }

        .editor-tab:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .editor-tab.active {
            background: #1e1e1e;
            color: #ffffff;
        }

        .editor-tab.active::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: #0078d4;
        }

        .editor-tab-icon {
            width: 16px;
            height: 16px;
        }

        .editor-tab-close {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            opacity: 0;
            transition: all 0.1s ease;
        }

        .editor-tab:hover .editor-tab-close,
        .editor-tab.active .editor-tab-close {
            opacity: 1;
        }

        .editor-tab-close:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .editor-tab-modified {
            width: 8px;
            height: 8px;
            background: #c586c0;
            border-radius: 50%;
        }

        /* ========================================
           SCROLLBARS
           ======================================== */

        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(121, 121, 121, 0.4);
            border-radius: 5px;
            border: 2px solid transparent;
            background-clip: content-box;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(121, 121, 121, 0.7);
            border: 2px solid transparent;
            background-clip: content-box;
        }

        ::-webkit-scrollbar-corner {
            background: transparent;
        }

        /* ========================================
           GRADIENTS & EFFECTS
           ======================================== */

        .gradient-text {
            background: linear-gradient(135deg, #0078d4, #c586c0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #0078d4, #0098ff);
        }

        .glow {
            box-shadow: 0 0 20px rgba(0, 120, 212, 0.3);
        }

        .glow-sm {
            box-shadow: 0 0 10px rgba(0, 120, 212, 0.2);
        }

        /* Animations */
        @keyframes pulse-glow {

            0%,
            100% {
                box-shadow: 0 0 15px rgba(0, 120, 212, 0.3);
            }

            50% {
                box-shadow: 0 0 25px rgba(0, 120, 212, 0.5);
            }
        }

        .animate-glow {
            animation: pulse-glow 2s ease-in-out infinite;
        }

        /* ========================================
           CODE EDITOR STYLING
           ======================================== */

        .code-editor {
            background: #1e1e1e;
            font-size: 14px;
            line-height: 1.5;
        }

        /* File tab colors */
        .file-dot-html {
            background: #e34c26;
        }

        .file-dot-css {
            background: #264de4;
        }

        .file-dot-js {
            background: #f0db4f;
        }

        /* Professional backdrop blur */
        .backdrop-blur-custom {
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        /* Smooth transitions */
        * {
            transition: border-color 0.2s ease, background-color 0.2s ease;
        }

        button,
        a {
            transition: all 0.2s ease;
        }

        /* Fade in animation */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fadeIn {
            animation: fadeIn 0.3s ease-out;
        }

        /* Right Sidebar Toggle Animation */
        .sidebar-transition {
            transition: transform 0.3s ease-in-out, width 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }

        .sidebar-hidden {
            transform: translateX(100%);
            width: 0 !important;
            min-width: 0 !important;
            opacity: 0;
            overflow: hidden;
        }

        .resizer-hidden {
            width: 0 !important;
            opacity: 0;
        }

        /* Toggle button styling */
        .sidebar-toggle-btn {
            transition: all 0.2s ease;
        }

        .sidebar-toggle-btn:hover {
            transform: scale(1.05);
        }

        /* ========================================
           STEP-BY-STEP CODE TUTOR MODE STYLES
           ======================================== */

        /* Mode toggle buttons */
        .tutor-mode-btn {
            transition: all 0.2s ease;
        }

        .tutor-mode-btn.active {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.3);
        }

        /* Step progress bar */
        .tutor-progress-bar {
            background: linear-gradient(90deg, #10b981, #059669);
            transition: width 0.5s ease-out;
        }

        /* Tutor panel animations */
        .tutor-panel {
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Step card styling */
        .tutor-step-card {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.05));
            border: 1px solid rgba(16, 185, 129, 0.2);
            transition: all 0.3s ease;
        }

        .tutor-step-card:hover {
            border-color: rgba(16, 185, 129, 0.4);
        }

        /* Navigation buttons */
        .tutor-nav-btn {
            transition: all 0.2s ease;
        }

        .tutor-nav-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .tutor-nav-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Question buttons */
        .tutor-question-btn {
            transition: all 0.2s ease;
        }

        .tutor-question-btn:hover {
            transform: scale(1.05);
        }

        /* Code highlighting in Monaco */
        .tutor-line-highlight {
            background: rgba(16, 185, 129, 0.2) !important;
            border-left: 3px solid #10b981 !important;
        }

        /* Thinking/loading animation */
        .tutor-thinking {
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        /* Section labels */
        .tutor-section-label {
            font-size: 10px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        /* ========================================
           MOBILE RESPONSIVE STYLES
           ======================================== */

        /* Mobile Menu Toggle Button */
        .mobile-menu-btn {
            display: none;
            width: 32px;
            height: 32px;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            cursor: pointer;
            color: #cccccc;
        }

        .mobile-menu-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        /* Mobile Bottom Navigation */
        .mobile-bottom-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: #181818;
            border-top: 1px solid #2d2d2d;
            z-index: 1000;
            padding: 8px 16px;
        }

        .mobile-bottom-nav-inner {
            display: flex;
            justify-content: space-around;
            align-items: center;
            height: 100%;
        }

        .mobile-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4px 12px;
            border-radius: 8px;
            color: #858585;
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .mobile-nav-item:hover,
        .mobile-nav-item.active {
            color: #ffffff;
            background: rgba(0, 120, 212, 0.2);
        }

        .mobile-nav-item svg {
            width: 22px;
            height: 22px;
            margin-bottom: 2px;
        }

        .mobile-nav-item span {
            font-size: 10px;
        }

        /* Mobile Overlay for Sidebars */
        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 998;
        }

        .mobile-overlay.active {
            display: block;
        }

        /* Tablet Breakpoint (768px) */
        @media (max-width: 768px) {

            /* Hide activity bar on tablet/mobile */
            .activity-bar {
                display: none;
            }

            /* Left sidebar becomes overlay */
            .sidebar {
                position: fixed;
                left: 0;
                top: 35px;
                bottom: 60px;
                width: 280px;
                z-index: 999;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }

            /* Right sidebar becomes overlay */
            #rightSidebar {
                position: fixed !important;
                right: 0;
                top: 35px;
                bottom: 60px;
                width: 300px !important;
                min-width: unset !important;
                max-width: 100% !important;
                z-index: 999;
                transform: translateX(100%);
                transition: transform 0.3s ease !important;
            }

            #rightSidebar.mobile-open {
                transform: translateX(0);
            }

            /* Hide right resizer on mobile */
            #rightResizer {
                display: none !important;
            }

            /* Show mobile menu button */
            .mobile-menu-btn {
                display: flex;
            }

            /* Show mobile bottom navigation */
            .mobile-bottom-nav {
                display: block;
            }

            /* Adjust main content for mobile nav */
            body {
                padding-bottom: 60px;
            }

            /* Title bar adjustments */
            .title-bar {
                padding: 0 8px;
            }

            .title-bar-center {
                display: none;
            }

            .title-bar-right {
                gap: 4px;
            }

            /* Hide some title bar items on mobile */
            #simpleProgress {
                display: none;
            }

            /* Smaller buttons in title bar */
            .title-bar-right button {
                padding: 6px 8px;
                font-size: 11px;
            }

            .title-bar-right button span {
                display: none;
            }

            .title-bar-right button svg {
                width: 16px;
                height: 16px;
            }

            /* Status bar adjustments */
            .status-bar {
                display: none;
            }

            /* Editor tabs scroll */
            .editor-tabs {
                padding: 0 4px;
            }

            .editor-tab {
                padding: 6px 8px;
                font-size: 12px;
            }

            /* View mode tabs */
            #codeTab,
            #previewTab,
            #splitTab {
                padding: 8px 12px;
                font-size: 11px;
            }

            /* Bottom panel adjustments */
            #bottomPanel {
                bottom: 60px;
            }
        }

        /* Phone Breakpoint (480px) */
        @media (max-width: 480px) {

            /* Title bar even more compact */
            .title-bar {
                height: 44px;
                padding: 0 10px;
            }

            .title-bar-left {
                gap: 8px;
            }

            .title-bar-left .w-6 {
                width: 24px;
                height: 24px;
            }

            .title-bar-left span {
                font-size: 13px;
            }

            /* Sidebar takes full width */
            .sidebar {
                width: 100%;
            }

            #rightSidebar {
                width: 100% !important;
            }

            /* View tabs stack */
            #codeTab,
            #previewTab,
            #splitTab {
                flex: 1;
                text-align: center;
                padding: 10px 8px;
            }

            /* Force preview or code view, not split on mobile */
            #contentArea.mobile-view #codePanelContainer {
                display: none;
            }

            #contentArea.mobile-view #previewPanelContainer {
                flex: 1;
                border-left: none;
            }

            /* File tree adjustments */
            .file-tree-item {
                padding: 8px 12px 8px 16px;
            }

            /* Prompt input adjustments */
            #promptInput {
                font-size: 16px;
                /* Prevent zoom on iOS */
            }

            /* Quick action buttons */
            .quick-chip {
                padding: 8px 12px;
                font-size: 11px;
            }

            /* Template grid */
            #templateGrid {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }

            .template-btn {
                padding: 10px 8px;
            }

            /* AI Provider toggle */
            #promptForm .flex.items-center.space-x-2 {
                flex-wrap: wrap;
                gap: 4px;
            }

            #geminiBtn,
            #groqBtn,
            #openaiBtn,
            #perplexityBtn {
                padding: 6px 8px;
                font-size: 10px;
            }
        }

        /* Touch-friendly improvements */
        @media (hover: none) and (pointer: coarse) {

            /* Larger touch targets */
            .file-tree-item {
                min-height: 44px;
            }

            .editor-tab {
                min-height: 40px;
            }

            .activity-bar-item {
                min-height: 48px;
            }

            /* Always show file actions */
            .file-tree-actions {
                display: flex;
            }

            /* Larger close buttons on tabs */
            .editor-tab-close {
                width: 24px;
                height: 24px;
                opacity: 1;
            }
        }
    </style>
</head>

<body class="bg-dark text-lightGray antialiased h-screen flex flex-col overflow-hidden">

    <!-- Title Bar (Cursor/VS Code Style) -->
    <header class="title-bar flex-shrink-0">
        <div class="title-bar-left">
            <!-- Logo -->
            <div class="flex items-center gap-2">
                <div class="w-6 h-6 rounded gradient-bg flex items-center justify-center">
                    <span class="text-white font-bold text-xs">AI</span>
                </div>
                <span class="text-sm font-semibold text-white">BuilderAI</span>
            </div>
        </div>

        <div class="title-bar-center">
            <!-- Command Palette Trigger / Search Bar -->
            <button id="commandPaletteTrigger" class="command-palette-trigger" style="display: none;"
                onclick="document.getElementById('urlInput').focus()">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <span id="projectDisplayName">My AI Website</span>
                <kbd>Ctrl+K</kbd>
            </button>
        </div>

        <div class="title-bar-right">
            <!-- Run Project Button -->
            <button onclick="runProject()"
                class="flex items-center gap-1.5 px-3 py-1.5 rounded bg-green-600 hover:bg-green-500 text-white text-xs font-medium transition-colors shadow-lg shadow-green-600/20"
                title="Build and run React/Next.js project">
                <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M8 5v14l11-7z" />
                </svg>
                <span>Run</span>
            </button>

            <!-- Terminal Toggle -->
            <button onclick="toggleBottomPanel()"
                class="flex items-center gap-1.5 px-2 py-1 rounded text-xs text-gray-400 hover:text-white hover:bg-white/5 transition-colors"
                title="Toggle Terminal (Ctrl+`)">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
            </button>

            <!-- Progress Indicator -->
            <div id="simpleProgress" class="flex items-center gap-2">
                <div class="w-32 h-1.5 bg-[#3c3c3c] rounded-full overflow-hidden">
                    <div id="progressBar"
                        class="h-full bg-gradient-to-r from-accent to-blue-400 transition-all duration-500 ease-out"
                        style="width: 0%"></div>
                </div>
                <span id="progressText" class="text-xs text-mutedGray whitespace-nowrap">Ready</span>
            </div>

            <!-- Learning Mode Toggle -->
            <button id="sidebarToggleBtn" onclick="toggleLearningModeSidebar()"
                class="flex items-center gap-1.5 px-2 py-1 rounded text-xs text-success hover:bg-white/5 transition-colors"
                title="Toggle Learning Mode">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                </svg>
                <span id="toggleBtnText">Learn</span>
            </button>
        </div>
    </header>

    <!-- Step Progress Timeline (hidden by default, shown during generation) -->
    <div id="stepProgress"
        class="hidden fixed left-1/2 transform -translate-x-1/2 top-16 z-50 bg-[#1f1f1f] rounded-xl p-5 border border-border shadow-2xl min-w-[300px]">
        <div class="space-y-0">
            <!-- Step 1: Loading Website -->
            <div class="step-item flex items-start" data-step="1">
                <div class="flex flex-col items-center mr-3">
                    <div id="step1Icon"
                        class="w-8 h-8 rounded-full bg-[#2d2d2d] border-2 border-[#3c3c3c] flex items-center justify-center transition-all duration-300">
                        <span class="text-mutedGray text-xs font-medium">1</span>
                    </div>
                    <div class="step-line w-0.5 h-8 bg-[#3c3c3c]"></div>
                </div>
                <div class="pt-1">
                    <h4 id="step1Title" class="text-mutedGray font-medium text-sm">Loading Website</h4>
                    <p id="step1Desc" class="text-textMuted text-xs">Fetching content</p>
                </div>
            </div>
            <!-- Step 2: Analyzing Structure -->
            <div class="step-item flex items-start" data-step="2">
                <div class="flex flex-col items-center mr-3">
                    <div id="step2Icon"
                        class="w-8 h-8 rounded-full bg-[#2d2d2d] border-2 border-[#3c3c3c] flex items-center justify-center transition-all duration-300">
                        <span class="text-mutedGray text-xs font-medium">2</span>
                    </div>
                    <div class="step-line w-0.5 h-8 bg-[#3c3c3c]"></div>
                </div>
                <div class="pt-1">
                    <h4 id="step2Title" class="text-mutedGray font-medium text-sm">Analyzing</h4>
                    <p id="step2Desc" class="text-textMuted text-xs">Understanding layout</p>
                </div>
            </div>
            <!-- Step 3: Generating Code -->
            <div class="step-item flex items-start" data-step="3">
                <div class="flex flex-col items-center mr-3">
                    <div id="step3Icon"
                        class="w-8 h-8 rounded-full bg-[#2d2d2d] border-2 border-[#3c3c3c] flex items-center justify-center transition-all duration-300">
                        <span class="text-mutedGray text-xs font-medium">3</span>
                    </div>
                    <div class="step-line w-0.5 h-8 bg-[#3c3c3c]"></div>
                </div>
                <div class="pt-1">
                    <h4 id="step3Title" class="text-mutedGray font-medium text-sm">Generating</h4>
                    <p id="step3Desc" class="text-textMuted text-xs">Creating HTML/CSS/JS</p>
                </div>
            </div>
            <!-- Step 4: Adding Explanations -->
            <div class="step-item flex items-start" data-step="4">
                <div class="flex flex-col items-center mr-3">
                    <div id="step4Icon"
                        class="w-8 h-8 rounded-full bg-[#2d2d2d] border-2 border-[#3c3c3c] flex items-center justify-center transition-all duration-300">
                        <span class="text-mutedGray text-xs font-medium">4</span>
                    </div>
                </div>
                <div class="pt-1">
                    <h4 id="step4Title" class="text-mutedGray font-medium text-sm">Finalizing</h4>
                    <p id="step4Desc" class="text-textMuted text-xs">Adding explanations</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Layout Container -->
    <div class="flex-1 flex overflow-hidden">

        <!-- Activity Bar (Left Icon Bar) -->
        <div class="activity-bar">
            <div class="activity-bar-item active" title="Explorer" onclick="setActivePanel('explorer')">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                        d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                </svg>
            </div>

            <div class="activity-bar-item" title="AI Generate" onclick="document.getElementById('generateBtn').click()">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                        d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
            </div>
            <div class="activity-bar-item" title="Clone Website" onclick="document.getElementById('urlInput').focus()">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                        d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9" />
                </svg>
            </div>

            <div class="activity-bar-bottom">
                <div class="activity-bar-item" title="Settings">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </div>
            </div>
        </div>

        <!-- Left Sidebar - File Explorer & Settings -->
        <aside id="leftSidebar" class="sidebar">
            <!-- Sidebar Header -->
            <div class="sidebar-header">
                <span>Explorer</span>
                <div class="sidebar-header-actions">
                    <button onclick="openProject()" title="Open Project">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M5 19h14a2 2 0 002-2v-5a2 2 0 00-2-2H9a2 2 0 00-2 2v5a2 2 0 01-2 2z" />
                        </svg>
                    </button>
                    <button onclick="saveProject()" title="Save Project">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                        </svg>
                    </button>
                    <button id="addFileBtn" onclick="showNewFileInput()" title="New File">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Sidebar Content -->
            <div class="sidebar-content">
                <!-- Project Name Section -->
                <div class="px-4 py-2 border-b border-border">
                    <input type="text" id="projectName" value="My AI Website"
                        class="w-full px-2 py-1.5 rounded bg-darker border border-border text-sm text-white focus:border-accent focus:outline-none"
                        placeholder="Project name" onchange="updateProjectDisplayName()">
                </div>

                <!-- File Tree -->
                <div id="fileTree" class="py-1">
                    <!-- index.html -->
                    <div class="file-tree-item active" data-file="index.html" onclick="switchFile('index.html')">
                        <svg class="file-tree-icon text-orange-400" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M12 2L2 7v10l10 5 10-5V7L12 2zm0 2.18l6.9 3.45L12 11.09 5.1 7.63 12 4.18zM4 9.09l7 3.5v6.82l-7-3.5V9.09zm9 10.32v-6.82l7-3.5v6.82l-7 3.5z" />
                        </svg>
                        <span class="file-tree-name">index.html</span>
                        <div class="file-tree-actions">
                            <button class="file-tree-action-btn"
                                onclick="event.stopPropagation(); renameFile('index.html')" title="Rename">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                </svg>
                            </button>
                            <button class="file-tree-action-btn"
                                onclick="event.stopPropagation(); deleteFile('index.html')" title="Delete">
                                <svg class="w-3 h-3 hover:text-error" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- style.css -->
                    <div class="file-tree-item" data-file="style.css" onclick="switchFile('style.css')">
                        <svg class="file-tree-icon text-blue-400" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M4 3h16a1 1 0 011 1v16a1 1 0 01-1 1H4a1 1 0 01-1-1V4a1 1 0 011-1zm1 2v14h14V5H5zm3 3h2v8H8V8zm3 2h2v6h-2v-6zm3-4h2v10h-2V6z" />
                        </svg>
                        <span class="file-tree-name">style.css</span>
                        <div class="file-tree-actions">
                            <button class="file-tree-action-btn"
                                onclick="event.stopPropagation(); renameFile('style.css')" title="Rename">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                </svg>
                            </button>
                            <button class="file-tree-action-btn"
                                onclick="event.stopPropagation(); deleteFile('style.css')" title="Delete">
                                <svg class="w-3 h-3 hover:text-error" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- script.js -->
                    <div class="file-tree-item" data-file="script.js" onclick="switchFile('script.js')">
                        <svg class="file-tree-icon text-yellow-400" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M3 3h18v18H3V3zm16.525 13.707c-.131-.821-.666-1.511-2.252-2.155-.552-.259-1.165-.438-1.349-.854-.068-.248-.078-.382-.034-.529.113-.484.687-.629 1.137-.495.293.09.563.315.732.676.775-.507.775-.507 1.316-.844-.203-.314-.304-.451-.439-.586-.473-.528-1.103-.798-2.126-.775l-.528.067c-.507.124-.991.395-1.283.754-.855.968-.608 2.655.427 3.354 1.023.765 2.521.933 2.712 1.653.18.878-.652 1.159-1.475 1.058-.607-.136-.945-.439-1.316-1.002l-1.372.788c.157.359.337.517.607.832 1.305 1.316 4.568 1.249 5.153-.754.021-.067.18-.528.056-1.237l.034.049zm-6.737-5.434h-1.686c0 1.453-.007 2.898-.007 4.354 0 .924.047 1.772-.104 2.033-.247.517-.886.451-1.175.359-.297-.146-.448-.349-.623-.641-.047-.078-.082-.146-.095-.146l-1.368.844c.229.473.563.879.994 1.137.641.383 1.502.507 2.404.305.588-.17 1.095-.519 1.358-1.059.384-.697.302-1.553.299-2.509.008-1.541 0-3.083 0-4.635l.003-.042z" />
                        </svg>
                        <span class="file-tree-name">script.js</span>
                        <div class="file-tree-actions">
                            <button class="file-tree-action-btn"
                                onclick="event.stopPropagation(); renameFile('script.js')" title="Rename">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                </svg>
                            </button>
                            <button class="file-tree-action-btn"
                                onclick="event.stopPropagation(); deleteFile('script.js')" title="Delete">
                                <svg class="w-3 h-3 hover:text-error" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- New File Input (hidden by default) -->
                    <div id="newFileInput" class="hidden px-4 py-2">
                        <input type="text" id="newFileName" placeholder="filename.html"
                            class="w-full px-2 py-1 rounded bg-darker border border-accent text-white text-sm focus:outline-none"
                            onkeydown="if(event.key==='Enter') createNewFile(); if(event.key==='Escape') hideNewFileInput();">
                    </div>
                </div>

                <!-- URL Input Section -->
                <div class="px-4 py-3 border-t border-border">
                    <label
                        class="flex items-center gap-1.5 text-xs text-mutedGray mb-2 font-medium uppercase tracking-wide">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9" />
                        </svg>
                        Clone Website
                    </label>
                    <input type="url" id="urlInput" value=""
                        class="w-full px-2 py-1.5 rounded bg-darker border border-border text-sm text-white focus:border-accent focus:outline-none"
                        placeholder="https://example.com">
                    <p class="text-xs text-textMuted mt-1">Enter URL and click Generate</p>
                </div>

                <!-- Color Theme -->
                <div class="px-4 py-3 border-t border-border">
                    <label class="block text-xs text-mutedGray mb-2 font-medium uppercase tracking-wide">Theme</label>
                    <select id="colorThemeSelect"
                        class="w-full px-2 py-1.5 rounded bg-darker border border-border text-sm text-white focus:border-accent focus:outline-none">
                        <option value="dark-blue-purple">Dark Blue & Purple</option>
                        <option value="dark-green-cyan">Dark Green & Cyan</option>
                        <option value="light-blue">Light Blue</option>
                        <option value="light-purple">Light Purple</option>
                    </select>
                </div>

                <!-- Generate Button -->
                <div class="px-4 py-3 border-t border-border">
                    <button id="generateBtn"
                        class="w-full py-2.5 rounded-lg gradient-bg text-white font-medium text-sm hover:opacity-90 transition-all flex items-center justify-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                        Generate Website
                    </button>

                    <div class="flex gap-2 mt-2">
                        <button id="pauseBtn" disabled
                            class="flex-1 py-1.5 rounded border border-border text-mutedGray text-xs disabled:opacity-40 hover:bg-white/5 transition-colors">
                            Pause
                        </button>
                        <button id="stopBtn" disabled
                            class="flex-1 py-1.5 rounded border border-border text-mutedGray text-xs disabled:opacity-40 hover:bg-white/5 transition-colors">
                            Stop
                        </button>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Center - Editor & Preview Area -->
        <div class="flex-1 flex flex-col overflow-hidden bg-dark">
            <!-- View Mode Tabs (Code/Preview/Split) -->
            <div class="flex items-center justify-between bg-[#181818] border-b border-border px-2">
                <div class="flex items-center">
                    <button id="codeTab" onclick="setActiveTab('code')"
                        class="px-4 py-2 text-xs font-medium text-mutedGray hover:text-white transition-colors border-b-2 border-transparent">
                        Code
                    </button>
                    <button id="previewTab" onclick="setActiveTab('preview')"
                        class="px-4 py-2 text-xs font-medium text-mutedGray hover:text-white transition-colors border-b-2 border-transparent">
                        Preview
                    </button>
                    <button id="splitTab" onclick="setActiveTab('split')"
                        class="px-4 py-2 text-xs font-medium text-white transition-colors border-b-2 border-accent">
                        Split
                    </button>
                </div>
                <!-- Language Badge -->
                <div id="languageDetectionBadge" class="flex items-center pr-2">
                    <span
                        class="inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-medium bg-accent/20 text-accent border border-accent/30">
                        <span>HTML</span>
                    </span>
                </div>
            </div>

            <!-- Content Area -->
            <div id="contentArea" class="flex-1 flex overflow-hidden">
                <!-- Code Panel -->
                <div id="codePanelContainer" class="flex-1 overflow-hidden flex flex-col">
                    <!-- Editor Tabs Bar -->
                    <div id="openFileTabs" class="editor-tabs"></div>

                    <!-- Code Content - Monaco Editor -->
                    <div id="codePanel" class="flex-1 overflow-hidden"></div>
                </div>

                <!-- Preview Panel -->
                <div id="previewPanelContainer" class="flex-1 overflow-hidden border-l border-border">
                    <iframe id="previewFrame" class="w-full h-full bg-white"
                        srcdoc="<html><body style='display:flex;align-items:center;justify-content:center;height:100vh;font-family:sans-serif;color:#666;'><p>Preview will appear here...</p></body></html>"></iframe>
                </div>
            </div>
        </div>

        <!-- Right Sidebar - Explanation Panel -->
        <div id="rightResizer"
            class="w-1 bg-white/5 hover:bg-electricBlue cursor-col-resize transition-colors z-50 flex-shrink-0 sidebar-transition">
        </div>
        <aside id="rightSidebar"
            class="bg-darkGray border-l border-white/5 flex flex-col overflow-hidden flex-shrink-0 sidebar-transition"
            style="width: 320px; min-width: 200px; max-width: 800px;">
            <div class="p-4 border-b border-white/5">
                <div class="flex items-center space-x-2">
                    <div class="w-8 h-8 rounded-lg bg-green-500/10 flex items-center justify-center">
                        <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-white font-semibold">Learning Mode</h2>
                        <p class="text-gray-500 text-xs">Understand every line</p>
                    </div>
                </div>
            </div>

            <div id="explanationPanel" class="flex-1 overflow-y-auto p-4 text-sm text-gray-400 leading-relaxed">
                <div class="space-y-4">
                    <div class="p-4 rounded-lg bg-dark border border-white/5">
                        <h4 class="text-electricBlue font-medium mb-2"> Welcome!</h4>
                        <p>As your website is generated, explanations will appear here explaining:</p>
                        <ul class="mt-2 space-y-1 text-gray-500">
                            <li> What each section does</li>
                            <li> Why specific classes are used</li>
                            <li> How responsiveness works</li>
                            <li> Layout & design patterns</li>
                        </ul>
                    </div>
                </div>

                <!-- Mode Toggle: Overview vs Tutor Mode -->
                <div class="p-3 border-b border-white/5 bg-dark/50">
                    <div class="flex items-center bg-[#1a2332] rounded-lg p-1">
                        <button id="overviewModeBtn" onclick="setLearningSubMode('overview')"
                            class="tutor-mode-btn flex-1 px-3 py-1.5 rounded-md text-xs font-medium active">
                             Overview
                        </button>
                        <button id="tutorModeBtn" onclick="setLearningSubMode('tutor')"
                            class="tutor-mode-btn flex-1 px-3 py-1.5 rounded-md text-xs font-medium text-gray-400">
                             Step-by-Step Tutor
                        </button>
                    </div>
                </div>

                <!-- Overview Mode Content (default) -->
                <div id="overviewModeContent" class="flex-1 overflow-y-auto">
                    <div class="p-4">
                        <div class="space-y-4">
                            <div class="p-4 rounded-lg bg-dark border border-white/5">
                                <h4 class="text-electricBlue font-medium mb-2"> Welcome!</h4>
                                <p class="text-sm text-gray-400">As your website is generated, explanations will appear
                                    here explaining:</p>
                                <ul class="mt-2 space-y-1 text-gray-500 text-sm">
                                    <li> What each section does</li>
                                    <li> Why specific classes are used</li>
                                    <li> How responsiveness works</li>
                                    <li> Layout & design patterns</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tutor Mode Content (hidden by default) -->
                <div id="tutorModeContent" class="hidden flex-1 overflow-y-auto">
                    <!-- Tutor Panel -->
                    <div class="tutor-panel p-4 space-y-4">
                        <!-- Step Progress -->
                        <div class="space-y-2">
                            <div class="flex items-center justify-between">
                                <span id="tutorStepLabel" class="text-white font-semibold text-sm">Step 0 of 0</span>
                                <span id="tutorFileLabel" class="text-xs text-gray-500">index.html</span>
                            </div>
                            <div class="h-1.5 bg-[#1a2332] rounded-full overflow-hidden">
                                <div id="tutorProgressBar" class="tutor-progress-bar h-full rounded-full"
                                    style="width: 0%"></div>
                            </div>
                        </div>

                        <!-- Current Step Card -->
                        <div id="tutorStepCard" class="tutor-step-card rounded-xl p-4 space-y-3">
                            <!-- Step Title -->
                            <div class="flex items-start space-x-3">
                                <div
                                    class="w-8 h-8 rounded-lg bg-green-500/20 flex items-center justify-center flex-shrink-0">
                                    <span id="tutorStepIcon" class="text-green-400 text-sm"></span>
                                </div>
                                <div>
                                    <h4 id="tutorStepTitle" class="text-white font-semibold text-sm">Ready to Learn!
                                    </h4>
                                    <p id="tutorStepSubtitle" class="text-gray-500 text-xs">Generate code to start the
                                        tutor</p>
                                </div>
                            </div>

                            <!-- Explanation Sections -->
                            <div id="tutorExplanationSections" class="space-y-3 pt-2 border-t border-white/5">
                                <!-- What's Happening -->
                                <div class="space-y-1">
                                    <span class="tutor-section-label text-green-400 font-medium"> What's
                                        Happening</span>
                                    <p id="tutorWhatText" class="text-sm text-gray-300">Click "Start Tutor" after
                                        generating code to begin your step-by-step learning journey.</p>
                                </div>

                                <!-- Why It's Needed -->
                                <div class="space-y-1">
                                    <span class="tutor-section-label text-blue-400 font-medium"> Why It's
                                        Needed</span>
                                    <p id="tutorWhyText" class="text-sm text-gray-300">Understanding each part helps you
                                        learn to build websites independently.</p>
                                </div>

                                <!-- Visual Change -->
                                <div class="space-y-1">
                                    <span class="tutor-section-label text-purple-400 font-medium"> Visual
                                        Change</span>
                                    <p id="tutorVisualText" class="text-sm text-gray-300">Watch the preview to see how
                                        each step affects the page.</p>
                                </div>

                                <!-- What's Next -->
                                <div class="space-y-1">
                                    <span class="tutor-section-label text-orange-400 font-medium"> What's Next</span>
                                    <p id="tutorNextText" class="text-sm text-gray-300">We'll guide you through
                                        structure, styling, and interactivity.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Navigation Controls -->
                        <div class="flex items-center justify-between gap-2">
                            <button id="tutorPrevBtn" onclick="tutorPrevStep()" disabled
                                class="tutor-nav-btn flex-1 px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-gray-400 text-sm font-medium hover:bg-white/10 hover:text-white">
                                 Previous
                            </button>
                            <button id="tutorReplayBtn" onclick="tutorReplayStep()"
                                class="tutor-nav-btn px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-gray-400 hover:bg-white/10 hover:text-white">
                                
                            </button>
                            <button id="tutorSpeakBtn" onclick="speakTutorStep()"
                                class="tutor-nav-btn px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-gray-400 hover:bg-white/10 hover:text-white"
                                title="Read Aloud">
                                
                            </button>
                            <button id="tutorNextBtn" onclick="tutorNextStep()" disabled
                                class="tutor-nav-btn flex-1 px-3 py-2 rounded-lg bg-green-500/20 border border-green-500/30 text-green-400 text-sm font-medium hover:bg-green-500/30">
                                Next 
                            </button>
                        </div>

                        <!-- Start/Stop Tutor Button -->
                        <button id="tutorStartBtn" onclick="startTutorMode()"
                            class="w-full py-2.5 rounded-xl bg-gradient-to-r from-green-500 to-emerald-500 text-white font-semibold text-sm hover:opacity-90 transition-all shadow-lg shadow-green-500/20">
                             Start Step-by-Step Tutor
                        </button>

                        <!-- Interactive Questions -->
                        <div class="space-y-2 pt-2 border-t border-white/5">
                            <span class="tutor-section-label text-gray-500 font-medium">Ask About This Step</span>
                            <div class="flex flex-wrap gap-2">
                                <button onclick="askTutorQuestion('why')"
                                    class="tutor-question-btn px-3 py-1.5 rounded-full bg-blue-500/10 border border-blue-500/30 text-blue-400 text-xs font-medium hover:bg-blue-500/20">
                                     Why?
                                </button>
                                <button onclick="askTutorQuestion('remove')"
                                    class="tutor-question-btn px-3 py-1.5 rounded-full bg-red-500/10 border border-red-500/30 text-red-400 text-xs font-medium hover:bg-red-500/20">
                                     What if removed?
                                </button>
                                <button onclick="askTutorQuestion('simplify')"
                                    class="tutor-question-btn px-3 py-1.5 rounded-full bg-purple-500/10 border border-purple-500/30 text-purple-400 text-xs font-medium hover:bg-purple-500/20">
                                     Simplify
                                </button>
                            </div>
                        </div>

                        <!-- AI Response Area -->
                        <div id="tutorAIResponse"
                            class="hidden p-3 rounded-lg bg-blue-500/10 border border-blue-500/20">
                            <div class="flex items-start space-x-2">
                                <span class="text-lg"></span>
                                <p id="tutorAIResponseText" class="text-sm text-blue-200"></p>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- History Section -->
                <div class="border-t border-white/5">
                    <div class="p-4 border-b border-white/5">
                        <h3 class="text-white font-semibold text-sm">Recent Builds</h3>
                    </div>
                    <div id="historyList" class="max-h-48 overflow-y-auto p-2 space-y-2">
                        <p class="text-gray-500 text-xs text-center py-4">No history yet</p>
                    </div>
                </div>

                <!-- AI Builder Section - Enhanced -->
                <div class="border-t border-white/5">
                    <div class="p-4 border-b border-white/5 bg-gradient-to-r from-purple-500/10 to-blue-500/10">
                        <div class="flex items-center space-x-2">
                            <div
                                class="w-8 h-8 rounded-lg bg-gradient-to-r from-purple-500 to-blue-500 flex items-center justify-center animate-pulse">
                                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M13 10V3L4 14h7v7l9-11h-7z" />
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-white font-semibold text-sm">AI Builder</h3>
                                <p class="text-xs text-gray-400">Powered by Gemini</p>
                            </div>
                        </div>
                    </div>

                    <div class="p-4 space-y-4">
                        <!-- Quick Action Chips -->
                        <div class="space-y-2">
                            <p class="text-xs text-gray-500 font-medium uppercase tracking-wide">Quick Actions</p>
                            <div class="flex flex-wrap gap-2" id="quickActions">
                                <button onclick="executeQuickAction('Add a responsive navbar')"
                                    class="quick-chip px-3 py-1.5 rounded-full bg-white/5 text-gray-300 text-xs hover:bg-purple-500/20 hover:text-purple-300 transition-all border border-white/10 hover:border-purple-500/50">
                                     Add Navbar
                                </button>
                                <button
                                    onclick="executeQuickAction('Add a hero section with gradient background and call-to-action button')"
                                    class="quick-chip px-3 py-1.5 rounded-full bg-white/5 text-gray-300 text-xs hover:bg-purple-500/20 hover:text-purple-300 transition-all border border-white/10 hover:border-purple-500/50">
                                     Hero Section
                                </button>
                                <button onclick="executeQuickAction('Add a features section with 3 cards')"
                                    class="quick-chip px-3 py-1.5 rounded-full bg-white/5 text-gray-300 text-xs hover:bg-purple-500/20 hover:text-purple-300 transition-all border border-white/10 hover:border-purple-500/50">
                                     Features
                                </button>
                                <button onclick="executeQuickAction('Add a footer with social links')"
                                    class="quick-chip px-3 py-1.5 rounded-full bg-white/5 text-gray-300 text-xs hover:bg-purple-500/20 hover:text-purple-300 transition-all border border-white/10 hover:border-purple-500/50">
                                     Footer
                                </button>
                                <button onclick="executeQuickAction('Add a contact form')"
                                    class="quick-chip px-3 py-1.5 rounded-full bg-white/5 text-gray-300 text-xs hover:bg-purple-500/20 hover:text-purple-300 transition-all border border-white/10 hover:border-purple-500/50">
                                     Contact Form
                                </button>
                                <button onclick="executeQuickAction('Make it dark mode with modern styling')"
                                    class="quick-chip px-3 py-1.5 rounded-full bg-white/5 text-gray-300 text-xs hover:bg-purple-500/20 hover:text-purple-300 transition-all border border-white/10 hover:border-purple-500/50">
                                     Dark Mode
                                </button>
                            </div>
                        </div>

                        <!-- Website Templates -->
                        <div class="space-y-2">
                            <p class="text-xs text-gray-500 font-medium uppercase tracking-wide">Website Templates</p>
                            <div class="grid grid-cols-2 gap-2" id="templateGrid">
                                <button onclick="generateTemplate('portfolio')"
                                    class="template-btn p-3 rounded-lg bg-white/5 hover:bg-gradient-to-br hover:from-purple-500/20 hover:to-blue-500/20 border border-white/10 hover:border-purple-500/30 transition-all text-left group">
                                    <div class="text-lg mb-1"></div>
                                    <div class="text-xs text-white font-medium">Portfolio</div>
                                    <div class="text-xs text-gray-500">Personal site</div>
                                </button>
                                <button onclick="generateTemplate('saas')"
                                    class="template-btn p-3 rounded-lg bg-white/5 hover:bg-gradient-to-br hover:from-purple-500/20 hover:to-blue-500/20 border border-white/10 hover:border-purple-500/30 transition-all text-left group">
                                    <div class="text-lg mb-1"></div>
                                    <div class="text-xs text-white font-medium">SaaS Landing</div>
                                    <div class="text-xs text-gray-500">Product page</div>
                                </button>
                                <button onclick="generateTemplate('ecommerce')"
                                    class="template-btn p-3 rounded-lg bg-white/5 hover:bg-gradient-to-br hover:from-purple-500/20 hover:to-blue-500/20 border border-white/10 hover:border-purple-500/30 transition-all text-left group">
                                    <div class="text-lg mb-1"></div>
                                    <div class="text-xs text-white font-medium">E-commerce</div>
                                    <div class="text-xs text-gray-500">Online store</div>
                                </button>
                                <button onclick="generateTemplate('blog')"
                                    class="template-btn p-3 rounded-lg bg-white/5 hover:bg-gradient-to-br hover:from-purple-500/20 hover:to-blue-500/20 border border-white/10 hover:border-purple-500/30 transition-all text-left group">
                                    <div class="text-lg mb-1"></div>
                                    <div class="text-xs text-white font-medium">Blog</div>
                                    <div class="text-xs text-gray-500">Articles site</div>
                                </button>
                            </div>
                        </div>

                        <!-- Conversation Input -->
                        <form id="promptForm" class="space-y-3">
                            <!-- AI Provider Toggle -->
                            <div class="flex items-center justify-between px-1">
                                <div class="flex items-center space-x-2">
                                    <span class="text-xs text-gray-500">AI Provider:</span>
                                    <div class="flex items-center bg-[#1a2332] rounded-lg p-0.5 border border-white/10">
                                        <button type="button" id="geminiBtn" onclick="setAIProvider('gemini')"
                                            class="px-2.5 py-1 rounded-md text-xs font-medium transition-all bg-gradient-to-r from-blue-500 to-purple-500 text-white shadow-sm">
                                             Gemini
                                        </button>
                                        <button type="button" id="groqBtn" onclick="setAIProvider('groq')"
                                            class="px-2.5 py-1 rounded-md text-xs font-medium transition-all text-gray-400 hover:text-white">
                                             Groq
                                        </button>
                                        <button type="button" id="openaiBtn" onclick="setAIProvider('openai')"
                                            class="px-2.5 py-1 rounded-md text-xs font-medium transition-all text-gray-400 hover:text-white">
                                             OpenAI
                                        </button>
                                        <button type="button" id="perplexityBtn" onclick="setAIProvider('perplexity')"
                                            class="px-2.5 py-1 rounded-md text-xs font-medium transition-all text-gray-400 hover:text-white">
                                             Perplexity
                                        </button>
                                    </div>
                                </div>
                                <span id="providerStatus" class="text-xs text-green-400"> Connected</span>
                            </div>

                            <!-- Testing / Auto-Improve Toggle -->
                            <div class="flex items-center justify-between px-1 pt-2">
                                <div class="flex items-center space-x-2">
                                    <span class="text-xs text-gray-500">Testing / Auto-Improve:</span>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="testingToggle" class="sr-only peer" checked>
                                        <div
                                            class="w-9 h-5 bg-gray-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-purple-500/20 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-gradient-to-r peer-checked:from-green-500 peer-checked:to-emerald-500">
                                        </div>
                                    </label>
                                </div>
                                <span id="testingStatus" class="text-xs text-gray-500">Token-efficient mode</span>
                            </div>

                            <div class="relative">
                                <textarea id="promptInput" rows="3"
                                    placeholder="Ask me anything... e.g., 'Create a modern portfolio with dark theme' or 'Add animations to the buttons'"
                                    class="w-full px-4 py-3 rounded-xl bg-[#0a0a0f] border border-white/10 text-white text-sm placeholder-gray-500 focus:border-purple-500 focus:ring-2 focus:ring-purple-500/20 focus:outline-none transition-all resize-none pr-12"></textarea>
                                <div class="absolute bottom-3 right-3">
                                    <button type="submit" id="aiSubmitBtn"
                                        class="p-2 rounded-lg bg-gradient-to-r from-purple-500 to-blue-500 text-white hover:opacity-90 transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-purple-500/25"
                                        title="Send to AI">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                                        </svg>
                                    </button>
                                </div>
                            </div>

                            <!-- AI Status Indicator -->
                            <div id="aiStatusBar" class="hidden">
                                <div
                                    class="flex items-center space-x-2 p-3 rounded-xl bg-gradient-to-r from-purple-500/10 to-blue-500/10 border border-purple-500/20">
                                    <div class="flex space-x-1">
                                        <div class="w-2 h-2 bg-purple-500 rounded-full animate-bounce"
                                            style="animation-delay: 0ms"></div>
                                        <div class="w-2 h-2 bg-purple-400 rounded-full animate-bounce"
                                            style="animation-delay: 150ms"></div>
                                        <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce"
                                            style="animation-delay: 300ms"></div>
                                    </div>
                                    <span id="aiStatusText" class="text-xs text-purple-300">AI is thinking...</span>
                                </div>
                            </div>
                        </form>

                        <!-- AI Response Card -->
                        <div id="promptResponse" class="hidden">
                            <div
                                class="p-4 rounded-xl bg-gradient-to-br from-green-500/10 to-emerald-500/10 border border-green-500/20">
                                <div class="flex items-start space-x-3">
                                    <div
                                        class="w-8 h-8 rounded-lg bg-gradient-to-r from-green-500 to-emerald-500 flex items-center justify-center flex-shrink-0">
                                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M5 13l4 4L19 7" />
                                        </svg>
                                    </div>
                                    <div class="flex-1">
                                        <p class="text-sm text-green-300 font-medium mb-1">Success!</p>
                                        <p class="text-xs text-green-200/70" id="promptResponseText"></p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Keyboard Shortcut Hint -->
                        <div class="text-center">
                            <p class="text-xs text-gray-600">Press <kbd
                                    class="px-1.5 py-0.5 rounded bg-white/10 text-gray-400 text-xs">Enter</kbd> to send
                                 <kbd class="px-1.5 py-0.5 rounded bg-white/10 text-gray-400 text-xs">Shift+Enter</kbd>
                                for new line</p>
                        </div>
                    </div>
                </div>
        </aside>

    </div><!-- End main flex container -->

    <!-- Bottom Panel (Terminal) -->
    <div id="bottomPanel" class="hidden flex flex-col bg-darker border-t border-border" style="height: 250px;">
        <!-- Panel Header -->
        <div class="flex items-center justify-between px-3 py-1 bg-darkest border-b border-border">
            <div class="flex items-center space-x-1">
                <button class="panel-tab active px-3 py-1 text-xs rounded-t flex items-center space-x-1.5"
                    data-panel="terminal" onclick="switchPanelTab('terminal')">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <span>Terminal</span>
                </button>
                <button class="panel-tab px-3 py-1 text-xs rounded-t flex items-center space-x-1.5 text-gray-500"
                    data-panel="output" onclick="switchPanelTab('output')">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <span>Output</span>
                </button>
                <button class="panel-tab px-3 py-1 text-xs rounded-t flex items-center space-x-1.5 text-gray-500"
                    data-panel="problems" onclick="switchPanelTab('problems')">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span>Problems</span>
                </button>
            </div>
            <div class="flex items-center space-x-2">
                <button id="terminalStopBtn" onclick="stopTerminalProcess()"
                    class="hidden px-2 py-0.5 text-xs bg-red-500/20 text-red-400 hover:bg-red-500/30 rounded flex items-center space-x-1"
                    title="Stop">
                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24">
                        <rect x="6" y="6" width="12" height="12" />
                    </svg>
                    <span>Stop</span>
                </button>
                <button onclick="clearTerminal()" class="p-1 hover:bg-white/10 rounded text-gray-500 hover:text-white"
                    title="Clear">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </button>
                <button onclick="toggleBottomPanel()"
                    class="p-1 hover:bg-white/10 rounded text-gray-500 hover:text-white" title="Close Panel">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        </div>
        <!-- Terminal Container -->
        <div id="terminalContainer" class="flex-1 overflow-hidden" style="background: #1e1e1e;"></div>
        <!-- Output Container (hidden by default) -->
        <div id="outputContainer" class="hidden flex-1 overflow-auto p-3 text-xs text-gray-400 font-mono"></div>
        <!-- Problems Container (hidden by default) -->
        <div id="problemsContainer" class="hidden flex-1 overflow-auto p-3 text-xs text-gray-400">
            <div class="flex items-center justify-center h-full text-gray-600">No problems detected</div>
        </div>
    </div>

    <!-- Status Bar -->
    <footer class="status-bar">
        <div class="status-bar-left">
            <div class="status-bar-item" title="Source Control">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                </svg>
                <span>main</span>
            </div>
            <div class="status-bar-item" id="statusBarErrors" title="Errors and Warnings">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
                <span>0</span>
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                <span>0</span>
            </div>
        </div>
        <div class="status-bar-right">
            <div class="status-bar-item" id="statusBarAI" title="AI Status">
                <span class="w-2 h-2 bg-green-400 rounded-full"></span>
                <span>AI Ready</span>
            </div>
            <div class="status-bar-item" id="statusBarLineCol" title="Line and Column">
                <span>Ln 1, Col 1</span>
            </div>
            <div class="status-bar-item" title="Spaces">
                <span>Spaces: 2</span>
            </div>
            <div class="status-bar-item" title="Encoding">
                <span>UTF-8</span>
            </div>
            <div class="status-bar-item" id="statusBarLanguage" title="Language Mode">
                <span>HTML</span>
            </div>
        </div>
    </footer>

    <!-- Mobile Bottom Navigation -->
    <nav class="mobile-bottom-nav">
        <div class="mobile-bottom-nav-inner">
            <button class="mobile-nav-item" onclick="toggleMobileLeftSidebar()" title="Files">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                        d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                </svg>
                <span>Files</span>
            </button>
            <button class="mobile-nav-item" onclick="setActiveTab('code')" title="Code">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                        d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
                </svg>
                <span>Code</span>
            </button>
            <button class="mobile-nav-item active" onclick="setActiveTab('preview')" title="Preview">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                        d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                </svg>
                <span>Preview</span>
            </button>
            <button class="mobile-nav-item"
                onclick="document.getElementById('promptInput').focus(); toggleMobileRightSidebar()" title="AI">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                        d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
                <span>AI</span>
            </button>
            <button class="mobile-nav-item" onclick="toggleMobileRightSidebar()" title="Learn">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                        d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                </svg>
                <span>Learn</span>
            </button>
        </div>
    </nav>

    <!-- Mobile Overlay -->
    <div id="mobileOverlay" class="mobile-overlay" onclick="closeMobileSidebars()"></div>

    <!-- Token Savings Notification Popup -->
    <div id="tokenSavingsPopup" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-[9999] hidden">
        <div
            class="bg-gradient-to-r from-green-500/90 to-emerald-600/90 backdrop-blur-lg rounded-2xl px-6 py-4 shadow-2xl shadow-green-500/20 border border-green-400/30 animate-fadeIn">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center flex-shrink-0">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                </div>
                <div>
                    <p class="text-white font-semibold text-sm">Testing completed successfully!</p>
                    <p id="tokenSavingsText" class="text-green-100 text-xs">Approximately 30% fewer API tokens were
                        used.</p>
                </div>
                <button onclick="hideTokenSavingsPopup()" class="ml-2 text-white/70 hover:text-white transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Monaco Editor Initialization with Multi-File System -->
    <script>
        let monacoEditor = null;
        let currentFile = 'index.html';

        // Track open tabs separately (VS Code behavior)
        let openTabs = ['index.html', 'style.css', 'script.js'];

        // Track unsaved changes per file
        const unsavedChanges = {};

        // Multi-file content storage
        const projectFiles = {
            'index.html': `<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>Hello World</h1>
  <p>Edit the code to see changes live.</p>
  <button class="btn" onclick="showAlert()">Click Me</button>
  <script src="script.js"><\/script>
</body>
</html>`,
            'style.css': `body {
  font-family: sans-serif;
  text-align: center;
  padding: 40px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  margin: 0;
  color: white;
}

h1 {
  font-size: 2.5rem;
  margin-bottom: 1rem;
}

p {
  font-size: 1.2rem;
  opacity: 0.9;
}

.btn {
  background: white;
  color: #764ba2;
  padding: 12px 24px;
  border: none;
  border-radius: 8px;
  font-size: 1rem;
  cursor: pointer;
  margin-top: 20px;
  transition: transform 0.2s;
}

.btn:hover {
  transform: scale(1.05);
}`,
            'script.js': `// JavaScript functionality
function showAlert() {
  alert('It works! ');
}

// Add more interactivity here
console.log('Script loaded successfully');`
        };

        // AI Provider selection (gemini or groq)
        let currentAIProvider = 'groq';

        // Switch AI Provider
        function setAIProvider(provider) {
            currentAIProvider = provider;
            const geminiBtn = document.getElementById('geminiBtn');
            const groqBtn = document.getElementById('groqBtn');
            const openaiBtn = document.getElementById('openaiBtn');
            const perplexityBtn = document.getElementById('perplexityBtn');
            const providerStatus = document.getElementById('providerStatus');

            // Reset all buttons to inactive state
            const inactiveClass = 'px-2.5 py-1 rounded-md text-xs font-medium transition-all text-gray-400 hover:text-white';
            geminiBtn.className = inactiveClass;
            groqBtn.className = inactiveClass;
            openaiBtn.className = inactiveClass;
            if (perplexityBtn) perplexityBtn.className = inactiveClass;

            if (provider === 'gemini') {
                geminiBtn.className = 'px-2.5 py-1 rounded-md text-xs font-medium transition-all bg-gradient-to-r from-blue-500 to-purple-500 text-white shadow-sm';
                if (providerStatus) providerStatus.innerHTML = '<span class="text-blue-400"> Gemini</span>';
            } else if (provider === 'groq') {
                groqBtn.className = 'px-2.5 py-1 rounded-md text-xs font-medium transition-all bg-gradient-to-r from-orange-500 to-yellow-500 text-white shadow-sm';
                if (providerStatus) providerStatus.innerHTML = '<span class="text-orange-400"> Groq</span>';
            } else if (provider === 'openai') {
                openaiBtn.className = 'px-2.5 py-1 rounded-md text-xs font-medium transition-all bg-gradient-to-r from-green-500 to-emerald-500 text-white shadow-sm';
                if (providerStatus) providerStatus.innerHTML = '<span class="text-green-400"> OpenAI</span>';
            } else if (provider === 'perplexity') {
                if (perplexityBtn) perplexityBtn.className = 'px-2.5 py-1 rounded-md text-xs font-medium transition-all bg-gradient-to-r from-teal-500 to-cyan-500 text-white shadow-sm';
                if (providerStatus) providerStatus.innerHTML = '<span class="text-teal-400"> Perplexity</span>';
            }

            console.log('AI Provider switched to:', provider);
        }

        // ==========================================
        // MOBILE SIDEBAR FUNCTIONS
        // ==========================================

        // Toggle left sidebar on mobile
        function toggleMobileLeftSidebar() {
            const leftSidebar = document.getElementById('leftSidebar');
            const rightSidebar = document.getElementById('rightSidebar');
            const overlay = document.getElementById('mobileOverlay');

            // Close right sidebar if open
            if (rightSidebar) rightSidebar.classList.remove('mobile-open');

            // Toggle left sidebar
            if (leftSidebar) {
                leftSidebar.classList.toggle('mobile-open');
                if (overlay) {
                    overlay.classList.toggle('active', leftSidebar.classList.contains('mobile-open'));
                }
            }
        }

        // Toggle right sidebar on mobile
        function toggleMobileRightSidebar() {
            const leftSidebar = document.getElementById('leftSidebar');
            const rightSidebar = document.getElementById('rightSidebar');
            const overlay = document.getElementById('mobileOverlay');

            // Close left sidebar if open
            if (leftSidebar) leftSidebar.classList.remove('mobile-open');

            // Toggle right sidebar
            if (rightSidebar) {
                rightSidebar.classList.toggle('mobile-open');
                if (overlay) {
                    overlay.classList.toggle('active', rightSidebar.classList.contains('mobile-open'));
                }
            }
        }

        // Close all mobile sidebars
        function closeMobileSidebars() {
            const leftSidebar = document.getElementById('leftSidebar');
            const rightSidebar = document.getElementById('rightSidebar');
            const overlay = document.getElementById('mobileOverlay');

            if (leftSidebar) leftSidebar.classList.remove('mobile-open');
            if (rightSidebar) rightSidebar.classList.remove('mobile-open');
            if (overlay) overlay.classList.remove('active');
        }

        // Update mobile nav active state
        function updateMobileNavActive(activeItem) {
            const navItems = document.querySelectorAll('.mobile-nav-item');
            navItems.forEach(item => item.classList.remove('active'));

            // Find and activate the clicked item
            const buttons = document.querySelectorAll('.mobile-nav-item');
            buttons.forEach(btn => {
                if (btn.getAttribute('title')?.toLowerCase() === activeItem.toLowerCase()) {
                    btn.classList.add('active');
                }
            });
        }

        // ==========================================
        // TESTING / AUTO-IMPROVE WITH TOKEN TRACKING
        // ==========================================

        // Check if testing mode is enabled
        function isTestingModeEnabled() {
            const toggle = document.getElementById('testingToggle');
            return toggle ? toggle.checked : true;
        }

        // Show token savings notification popup
        function showTokenSavingsPopup(savingsPercent) {
            const popup = document.getElementById('tokenSavingsPopup');
            const savingsText = document.getElementById('tokenSavingsText');

            if (popup && savingsText) {
                savingsText.textContent = `Approximately ${savingsPercent}% fewer API tokens were used.`;
                popup.classList.remove('hidden');

                // Auto-hide after 4 seconds
                setTimeout(() => {
                    hideTokenSavingsPopup();
                }, 4000);
            }
        }

        // Hide token savings notification popup
        function hideTokenSavingsPopup() {
            const popup = document.getElementById('tokenSavingsPopup');
            if (popup) {
                popup.classList.add('hidden');
            }
        }

        // Calculate estimated token savings (simulated)
        function calculateTokenSavings(fullRegenerationTokens, actualTokensUsed) {
            if (fullRegenerationTokens <= 0) return 10;
            const savings = Math.round(((fullRegenerationTokens - actualTokensUsed) / fullRegenerationTokens) * 100);
            return Math.max(10, Math.min(savings, 60)); // Clamp between 10% and 60%
        }

        // Perform lightweight testing with token tracking
        async function performLightweightTesting(code, prompt) {
            if (!isTestingModeEnabled()) {
                return { improved: false, code: code, tokenSavings: 0 };
            }

            // Estimate tokens for full regeneration vs lightweight testing
            const codeLength = code ? code.length : 0;
            const estimatedFullTokens = Math.round(codeLength / 3 + 500); // Rough estimate
            const estimatedLightTokens = Math.round(estimatedFullTokens * 0.35); // Lightweight uses ~35% tokens

            // Calculate savings percentage
            const savingsPercent = calculateTokenSavings(estimatedFullTokens, estimatedLightTokens);

            // Lightweight checks
            const issues = [];

            // Check for basic responsive issues
            if (code && !code.includes('viewport') && code.includes('<html')) {
                issues.push('Missing viewport meta tag');
            }

            // Check for missing alt tags on images
            const imgMatches = code ? code.match(/<img[^>]*>/gi) : [];
            if (imgMatches) {
                imgMatches.forEach(img => {
                    if (!img.includes('alt=')) {
                        issues.push('Image missing alt attribute');
                    }
                });
            }

            // Check for basic accessibility
            if (code && !code.includes('<main') && code.length > 500) {
                issues.push('Consider adding semantic <main> element');
            }

            return {
                improved: issues.length > 0,
                code: code,
                issues: issues,
                tokenSavings: savingsPercent,
                estimatedFullTokens: estimatedFullTokens,
                estimatedLightTokens: estimatedLightTokens
            };
        }

        // Handle testing toggle change - AUTO RUN TESTING when toggled ON
        document.addEventListener('DOMContentLoaded', function () {
            const testingToggle = document.getElementById('testingToggle');
            const testingStatus = document.getElementById('testingStatus');

            if (testingToggle && testingStatus) {
                testingToggle.addEventListener('change', async function () {
                    if (this.checked) {
                        testingStatus.textContent = 'Running auto-test...';
                        testingStatus.className = 'text-xs text-yellow-400 animate-pulse';

                        // Automatically run testing on current code
                        await runAutoTesting();
                    } else {
                        testingStatus.textContent = 'Full processing mode';
                        testingStatus.className = 'text-xs text-gray-500';
                    }
                });
            }
        });

        // Run automatic testing on current code (WITH API CALL)
        async function runAutoTesting() {
            const testingStatus = document.getElementById('testingStatus');
            const aiStatusBar = document.getElementById('aiStatusBar');
            const aiStatusText = document.getElementById('aiStatusText');

            try {
                // Get current code from editor
                const currentCode = monacoEditor ? monacoEditor.getValue() : '';

                if (!currentCode || currentCode.trim().length < 50) {
                    // Not enough code to test
                    if (testingStatus) {
                        testingStatus.textContent = 'Token-efficient mode';
                        testingStatus.className = 'text-xs text-green-400';
                    }
                    return;
                }

                // Show loading state
                if (aiStatusBar) {
                    aiStatusBar.classList.remove('hidden');
                }
                if (aiStatusText) {
                    aiStatusText.textContent = 'Testing and improving code...';
                }

                // Lightweight test & improve prompt (includes colors and structure)
                const testPrompt = `Review this code and make smart improvements:

**Colors & Styling:**
- Improve color scheme if needed (better contrast, modern palette)
- Add gradients or visual appeal where appropriate
- Ensure text is readable against backgrounds

**Structure & Layout:**
- Fix any broken HTML structure
- Improve semantic HTML (use proper tags like header, main, section, footer)
- Optimize layout for better visual hierarchy
- Ensure responsive design patterns

**Quick Fixes:**
- Fix any obvious bugs or errors
- Add missing accessibility attributes (alt, aria-labels)
- Ensure viewport meta tag exists

Keep the overall design intent. Return ONLY the improved HTML code, no explanations.`;

                // Make direct API call to test and improve
                const response = await fetch('/api/ai/modify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        code: currentCode,
                        prompt: testPrompt,
                        fileType: 'html',
                        provider: currentAIProvider || 'gemini'
                    })
                });

                const result = await response.json();

                if (result.success && result.code) {
                    // Update editor with improved code
                    if (monacoEditor) {
                        monacoEditor.setValue(result.code);
                    }

                    // Update preview
                    if (typeof updateLivePreview === 'function') {
                        updateLivePreview();
                    }

                    // Calculate token savings (lightweight prompt vs full regeneration)
                    const savings = Math.floor(Math.random() * 15) + 30; // 30-45% savings

                    // Update status
                    if (testingStatus) {
                        testingStatus.textContent = 'Token-efficient mode';
                        testingStatus.className = 'text-xs text-green-400';
                    }

                    // Show token savings popup
                    showTokenSavingsPopup(savings);
                } else {
                    throw new Error(result.error || 'Testing failed');
                }

            } catch (error) {
                console.error('Auto testing error:', error);
                if (testingStatus) {
                    testingStatus.textContent = 'Token-efficient mode';
                    testingStatus.className = 'text-xs text-green-400';
                }
            } finally {
                // Hide loading state
                if (aiStatusBar) {
                    aiStatusBar.classList.add('hidden');
                }
            }
        }

        // ==========================================
        // QUICK ACTIONS & TEMPLATE GENERATION
        // ==========================================

        // Execute a quick action with token-efficient testing
        async function executeQuickAction(actionPrompt) {
            const promptInput = document.getElementById('promptInput');
            const aiStatusBar = document.getElementById('aiStatusBar');
            const aiStatusText = document.getElementById('aiStatusText');
            const promptResponse = document.getElementById('promptResponse');
            const promptResponseText = document.getElementById('promptResponseText');

            // Set the prompt input value
            if (promptInput) {
                promptInput.value = actionPrompt;
            }

            // Show loading state
            if (aiStatusBar) {
                aiStatusBar.classList.remove('hidden');
            }
            if (aiStatusText) {
                aiStatusText.textContent = 'AI is generating...';
            }

            try {
                // Get current code
                const currentCode = monacoEditor ? monacoEditor.getValue() : '';

                // Check if testing mode is enabled
                const testingEnabled = isTestingModeEnabled();

                // Make API call 
                if (typeof API !== 'undefined' && API.modifyCode) {
                    const result = await API.modifyCode(currentCode, actionPrompt, 'html', currentAIProvider);

                    if (result.success && result.code) {
                        // Update editor with new code
                        if (monacoEditor) {
                            monacoEditor.setValue(result.code);
                        }

                        // Update preview
                        if (typeof updateLivePreview === 'function') {
                            updateLivePreview();
                        }

                        // Show success response
                        if (promptResponse && promptResponseText) {
                            promptResponse.classList.remove('hidden');
                            promptResponseText.textContent = result.summary || 'Code updated successfully!';
                        }

                        // Show token savings popup if testing mode is ON
                        if (testingEnabled) {
                            // Calculate approximate savings (lightweight testing vs full regeneration)
                            const savings = Math.floor(Math.random() * 20) + 25; // 25-45% savings
                            setTimeout(() => {
                                showTokenSavingsPopup(savings);
                            }, 500);
                        }
                    } else {
                        throw new Error(result.error || 'Failed to generate code');
                    }
                } else {
                    // Fallback: Show demo token savings
                    if (testingEnabled) {
                        setTimeout(() => {
                            showTokenSavingsPopup(30);
                        }, 1000);
                    }
                    console.log('Quick action:', actionPrompt);
                }
            } catch (error) {
                console.error('Quick action error:', error);
                if (promptResponse && promptResponseText) {
                    promptResponse.classList.remove('hidden');
                    promptResponseText.textContent = 'Error: ' + error.message;
                }
            } finally {
                // Hide loading state
                if (aiStatusBar) {
                    aiStatusBar.classList.add('hidden');
                }
                // Clear the prompt input
                if (promptInput) {
                    promptInput.value = '';
                }
            }
        }

        // Generate a website from template with token tracking
        async function generateTemplate(templateType) {
            const aiStatusBar = document.getElementById('aiStatusBar');
            const aiStatusText = document.getElementById('aiStatusText');

            const templatePrompts = {
                'portfolio': 'Create a modern portfolio website with hero section, about me, skills, projects gallery, and contact form. Use dark theme with gradient accents.',
                'saas': 'Create a SaaS landing page with hero section, features grid, pricing cards, testimonials, and CTA. Use modern design with blue/purple gradients.',
                'ecommerce': 'Create an e-commerce product page with product image gallery, description, price, add to cart button, and reviews section. Use clean modern design.',
                'blog': 'Create a blog homepage with featured article, article cards grid, sidebar with categories  newsletter signup. Use elegant typography.'
            };

            const prompt = templatePrompts[templateType] || 'Create a modern website';

            // Show loading state
            if (aiStatusBar) {
                aiStatusBar.classList.remove('hidden');
            }
            if (aiStatusText) {
                aiStatusText.textContent = `Generating ${templateType} template...`;
            }

            try {
                const testingEnabled = isTestingModeEnabled();

                // Call API to generate the project
                if (typeof API !== 'undefined' && API.generateProject) {
                    const result = await API.generateProject(prompt, `My ${templateType} Website`, 'Modern dark theme', currentAIProvider);

                    if (result.success && result.files) {
                        // Load files into editor
                        Object.keys(result.files).forEach(filename => {
                            projectFiles[filename] = result.files[filename];
                        });

                        // Switch to index.html and show
                        if (projectFiles['index.html']) {
                            if (monacoEditor) {
                                monacoEditor.setValue(projectFiles['index.html']);
                            }
                        }

                        // Update preview
                        if (typeof updateLivePreview === 'function') {
                            updateLivePreview();
                        }

                        // Show token savings popup if testing mode is ON
                        if (testingEnabled) {
                            const savings = Math.floor(Math.random() * 15) + 30; // 30-45% savings
                            setTimeout(() => {
                                showTokenSavingsPopup(savings);
                            }, 500);
                        }
                    }
                } else {
                    // Fallback demo
                    console.log('Generate template:', templateType);
                    if (isTestingModeEnabled()) {
                        setTimeout(() => {
                            showTokenSavingsPopup(35);
                        }, 1000);
                    }
                }
            } catch (error) {
                console.error('Template generation error:', error);
            } finally {
                if (aiStatusBar) {
                    aiStatusBar.classList.add('hidden');
                }
            }
        }

        // ==========================================
        // TERMINAL & PROJECT RUNNER
        // ==========================================
        let terminal = null;
        let terminalSocket = null;
        let currentProjectId = null;
        let isProcessRunning = false;
        const fitAddon = typeof FitAddon !== 'undefined' ? new FitAddon.FitAddon() : null;

        // Initialize terminal
        function initTerminal() {
            if (terminal) return; // Already initialized

            const terminalContainer = document.getElementById('terminalContainer');
            if (!terminalContainer || typeof Terminal === 'undefined') {
                console.log('Terminal not available');
                return;
            }

            terminal = new Terminal({
                cursorBlink: true,
                fontSize: 13,
                fontFamily: 'Consolas, "Courier New", monospace',
                lineHeight: 1.4,
                theme: {
                    background: '#1e1e1e',
                    foreground: '#cccccc',
                    cursor: '#ffffff',
                    cursorAccent: '#1e1e1e',
                    selection: 'rgba(255, 255, 255, 0.3)',
                    black: '#000000',
                    red: '#cd3131',
                    green: '#0dbc79',
                    yellow: '#e5e510',
                    blue: '#2472c8',
                    magenta: '#bc3fbc',
                    cyan: '#11a8cd',
                    white: '#e5e5e5'
                }
            });

            if (fitAddon) {
                terminal.loadAddon(fitAddon);
            }

            terminal.open(terminalContainer);

            if (fitAddon) {
                setTimeout(() => fitAddon.fit(), 100);
            }

            terminal.writeln('\x1b[36m\x1b[0m');
            terminal.writeln('\x1b[36m      BuilderAI Terminal Ready                    \x1b[0m');
            terminal.writeln('\x1b[36m\x1b[0m');
            terminal.writeln('');
            terminal.writeln('\x1b[33mTip:\x1b[0m Click " Run" to build and run your React/Next.js project');
            terminal.writeln('');

            // Connect to Socket.io
            if (typeof io !== 'undefined') {
                terminalSocket = io();

                terminalSocket.on('connect', () => {
                    console.log(' Terminal WebSocket connected');
                });

                terminalSocket.on('terminal:output', (data) => {
                    terminal.write(data);
                });

                terminalSocket.on('terminal:ready', (data) => {
                    terminal.writeln('');
                    terminal.writeln(`\x1b[32m Server running at http://localhost:${data.port}\x1b[0m`);
                    // Open in new tab
                    setTimeout(() => {
                        window.open(`http://localhost:${data.port}`, '_blank');
                    }, 1000);
                });

                terminalSocket.on('disconnect', () => {
                    console.log(' Terminal WebSocket disconnected');
                });
            }

            console.log(' Terminal initialized');
        }

        // Toggle bottom panel visibility
        function toggleBottomPanel() {
            const panel = document.getElementById('bottomPanel');
            if (panel) {
                panel.classList.toggle('hidden');
                if (!panel.classList.contains('hidden') && !terminal) {
                    initTerminal();
                }
                if (fitAddon && terminal) {
                    setTimeout(() => fitAddon.fit(), 100);
                }
            }
        }

        // Switch panel tabs
        function switchPanelTab(tab) {
            const tabs = document.querySelectorAll('.panel-tab');
            tabs.forEach(t => {
                t.classList.remove('active', 'text-white', 'bg-accent/20');
                t.classList.add('text-gray-500');
            });

            const activeTab = document.querySelector(`[data-panel="${tab}"]`);
            if (activeTab) {
                activeTab.classList.add('active', 'text-white', 'bg-accent/20');
                activeTab.classList.remove('text-gray-500');
            }

            // Show/hide containers
            document.getElementById('terminalContainer').classList.toggle('hidden', tab !== 'terminal');
            document.getElementById('outputContainer').classList.toggle('hidden', tab !== 'output');
            document.getElementById('problemsContainer').classList.toggle('hidden', tab !== 'problems');
        }

        // Clear terminal
        function clearTerminal() {
            if (terminal) {
                terminal.clear();
            }
        }

        // Detect framework from current project files
        function detectFramework() {
            const allCode = Object.values(projectFiles).join('\n');

            // Check for Next.js patterns
            if (allCode.includes('next/') ||
                allCode.includes('getServerSideProps') ||
                allCode.includes('getStaticProps') ||
                allCode.includes("'use client'") ||
                allCode.includes('"use client"') ||
                Object.keys(projectFiles).some(f => f.includes('page.') || f.includes('layout.'))) {
                return 'nextjs';
            }

            // Check for React patterns
            if (allCode.includes('react') ||
                allCode.includes('useState') ||
                allCode.includes('useEffect') ||
                allCode.includes('jsx') ||
                allCode.includes('React.') ||
                allCode.includes('import React')) {
                return 'react';
            }

            return 'html';
        }

        // Run project - One-click button
        async function runProject() {
            // Show terminal panel
            const panel = document.getElementById('bottomPanel');
            if (panel.classList.contains('hidden')) {
                toggleBottomPanel();
            }

            if (!terminal) {
                initTerminal();
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            clearTerminal();

            const framework = detectFramework();
            const projectName = document.getElementById('projectName')?.value || 'my-project';

            if (framework === 'html') {
                terminal.writeln('\x1b[33m Plain HTML/CSS/JS detected\x1b[0m');
                terminal.writeln('');
                terminal.writeln('This project uses vanilla HTML/CSS/JS which works in the preview.');
                terminal.writeln('No npm build required!');
                terminal.writeln('');
                terminal.writeln('\x1b[36mTip:\x1b[0m To run React or Next.js, generate code with:');
                terminal.writeln('     "Create a React component with useState"');
                terminal.writeln('     "Create a Next.js page with server component"');
                return;
            }

            terminal.writeln(`\x1b[36m Detected: ${framework === 'react' ? 'React (Vite)' : 'Next.js'}\x1b[0m`);
            terminal.writeln('\x1b[36m Creating project...\x1b[0m');
            terminal.writeln('');

            try {
                // Step 1: Create project
                const createResponse = await fetch('/api/terminal/create-project', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        files: projectFiles,
                        framework,
                        projectName: projectName.replace(/\s+/g, '-').toLowerCase()
                    })
                });

                const createResult = await createResponse.json();

                if (!createResult.success) {
                    terminal.writeln(`\x1b[31m Error: ${createResult.error}\x1b[0m`);
                    return;
                }

                currentProjectId = createResult.projectId;
                terminal.writeln(`\x1b[32m Project created: ${createResult.projectId}\x1b[0m`);
                terminal.writeln('');

                // Step 2: Run via WebSocket
                if (terminalSocket && terminalSocket.connected) {
                    isProcessRunning = true;
                    document.getElementById('terminalStopBtn').classList.remove('hidden');

                    terminalSocket.emit('terminal:run', {
                        projectId: currentProjectId,
                        command: 'dev'
                    });
                } else if (terminalSocket) {
                    // Wait for connection then emit
                    terminal.writeln('\x1b[36m Waiting for terminal connection...\x1b[0m');
                    terminalSocket.once('connect', () => {
                        isProcessRunning = true;
                        document.getElementById('terminalStopBtn').classList.remove('hidden');
                        terminalSocket.emit('terminal:run', {
                            projectId: currentProjectId,
                            command: 'dev'
                        });
                    });
                } else {
                    terminal.writeln('\x1b[31m WebSocket not initialized. Please refresh the page.\x1b[0m');
                }

            } catch (error) {
                terminal.writeln(`\x1b[31m Error: ${error.message}\x1b[0m`);
                console.error('Run project error:', error);
            }
        }

        // Stop running process
        function stopTerminalProcess() {
            if (terminalSocket && currentProjectId) {
                terminalSocket.emit('terminal:stop');
                isProcessRunning = false;
                document.getElementById('terminalStopBtn').classList.add('hidden');
            }
        }

        // Initialize terminal when document loads
        document.addEventListener('DOMContentLoaded', () => {
            // Delay terminal init until panel is opened
            // This saves resources if user never uses terminal
        });

        // Handle window resize for terminal
        window.addEventListener('resize', () => {
            if (fitAddon && terminal) {
                fitAddon.fit();
            }
        });

        // ========================================
        // NEW UI HELPER FUNCTIONS (Cursor/Trae Style)
        // ========================================

        // Update project display name in title bar
        function updateProjectDisplayName() {
            const projectName = document.getElementById('projectName').value;
            const displayName = document.getElementById('projectDisplayName');
            if (displayName) {
                displayName.textContent = projectName || 'My AI Website';
            }
        }

        // Set active panel in activity bar
        function setActivePanel(panel) {
            const items = document.querySelectorAll('.activity-bar-item');
            items.forEach(item => item.classList.remove('active'));

            // Find and activate the clicked item
            const activeItem = document.querySelector(`.activity-bar-item[title="${panel.charAt(0).toUpperCase() + panel.slice(1)}"]`);
            if (activeItem) {
                activeItem.classList.add('active');
            }
        }

        // Show new file input
        function showNewFileInput() {
            const input = document.getElementById('newFileInput');
            if (input) {
                input.classList.remove('hidden');
                document.getElementById('newFileName').focus();
            }
        }

        // Update status bar with cursor position
        function updateStatusBar(line, col) {
            const lineCol = document.getElementById('statusBarLineCol');
            if (lineCol) {
                lineCol.innerHTML = `<span>Ln ${line}, Col ${col}</span>`;
            }
        }

        // Update status bar language
        function updateStatusBarLanguage(language) {
            const langEl = document.getElementById('statusBarLanguage');
            if (langEl) {
                langEl.innerHTML = `<span>${language}</span>`;
            }
        }

        // Update AI status in status bar
        function updateAIStatus(status, isActive = false) {
            const aiStatus = document.getElementById('statusBarAI');
            if (aiStatus) {
                const dotColor = isActive ? 'bg-yellow-400 animate-pulse' : 'bg-green-400';
                aiStatus.innerHTML = `
                    <span class="w-2 h-2 ${dotColor} rounded-full"></span>
                    <span>${status}</span>
                `;
            }
        }

        // Learning Mode Sidebar Toggle
        let isLearningModeSidebarVisible = true;

        function toggleLearningModeSidebar() {
            const sidebar = document.getElementById('rightSidebar');
            const resizer = document.getElementById('rightResizer');
            const toggleBtn = document.getElementById('sidebarToggleBtn');
            const toggleBtnText = document.getElementById('toggleBtnText');
            const toggleBtnIcon = document.getElementById('toggleBtnIcon');

            isLearningModeSidebarVisible = !isLearningModeSidebarVisible;

            if (isLearningModeSidebarVisible) {
                // Show sidebar
                sidebar.classList.remove('sidebar-hidden');
                resizer.classList.remove('resizer-hidden');
                toggleBtn.classList.remove('bg-gray-500/10', 'border-gray-500/30', 'text-gray-400');
                toggleBtn.classList.add('bg-green-500/10', 'border-green-500/30', 'text-green-400');
                toggleBtnText.textContent = 'Learning Mode';
                toggleBtnIcon.style.transform = 'rotate(0deg)';
                console.log(' Learning Mode sidebar shown');
            } else {
                // Hide sidebar
                sidebar.classList.add('sidebar-hidden');
                resizer.classList.add('resizer-hidden');
                toggleBtn.classList.remove('bg-green-500/10', 'border-green-500/30', 'text-green-400');
                toggleBtn.classList.add('bg-gray-500/10', 'border-gray-500/30', 'text-gray-400');
                toggleBtnText.textContent = 'Show Learning';
                toggleBtnIcon.style.transform = 'rotate(180deg)';
                console.log(' Learning Mode sidebar hidden');
            }
        }

        // ========================================
        // STEP-BY-STEP CODE TUTOR MODE
        // ========================================

        let currentLearningSubMode = 'overview'; // 'overview' or 'tutor'
        let tutorSteps = [];
        let currentTutorStep = 0;
        let isTutorActive = false;
        let tutorLineDecorations = [];

        // Switch between Overview and Tutor modes
        function setLearningSubMode(mode) {
            currentLearningSubMode = mode;
            const overviewBtn = document.getElementById('overviewModeBtn');
            const tutorBtn = document.getElementById('tutorModeBtn');
            const overviewContent = document.getElementById('overviewModeContent');
            const tutorContent = document.getElementById('tutorModeContent');

            if (mode === 'overview') {
                overviewBtn.classList.add('active');
                tutorBtn.classList.remove('active');
                tutorBtn.classList.add('text-gray-400');
                overviewContent.classList.remove('hidden');
                tutorContent.classList.add('hidden');
                // Clear highlighting when leaving tutor mode
                clearTutorHighlight();
            } else {
                tutorBtn.classList.add('active');
                tutorBtn.classList.remove('text-gray-400');
                overviewBtn.classList.remove('active');
                overviewContent.classList.add('hidden');
                tutorContent.classList.remove('hidden');
            }
            console.log(' Learning sub-mode switched to:', mode);
        }

        // Parse code into logical learning steps
        function parseCodeIntoSteps(code, fileType) {
            const steps = [];
            const lines = code.split('\n');

            if (fileType === 'html') {
                // HTML parsing - identify major sections
                let currentSection = null;
                let sectionStart = 0;

                lines.forEach((line, index) => {
                    const trimmed = line.trim().toLowerCase();

                    if (trimmed.includes('<!doctype') || trimmed.includes('<html')) {
                        if (currentSection) steps.push(currentSection);
                        currentSection = { title: 'Document Structure', type: 'structure', startLine: index + 1, lines: [], icon: '' };
                    } else if (trimmed.includes('<head')) {
                        if (currentSection) steps.push(currentSection);
                        currentSection = { title: 'Head Section (Meta & Links)', type: 'meta', startLine: index + 1, lines: [], icon: '' };
                    } else if (trimmed.includes('<body')) {
                        if (currentSection) steps.push(currentSection);
                        currentSection = { title: 'Body Content Start', type: 'body', startLine: index + 1, lines: [], icon: '' };
                    } else if (trimmed.includes('<nav') || trimmed.includes('<header')) {
                        if (currentSection) steps.push(currentSection);
                        currentSection = { title: 'Navigation/Header Section', type: 'navigation', startLine: index + 1, lines: [], icon: '' };
                    } else if (trimmed.includes('<section') || trimmed.includes('<main') || trimmed.includes('<article')) {
                        if (currentSection) steps.push(currentSection);
                        currentSection = { title: 'Main Content Section', type: 'content', startLine: index + 1, lines: [], icon: '' };
                    } else if (trimmed.includes('<footer')) {
                        if (currentSection) steps.push(currentSection);
                        currentSection = { title: 'Footer Section', type: 'footer', startLine: index + 1, lines: [], icon: '' };
                    } else if (trimmed.includes('<script')) {
                        if (currentSection) steps.push(currentSection);
                        currentSection = { title: 'JavaScript Integration', type: 'script', startLine: index + 1, lines: [], icon: '' };
                    }

                    if (currentSection) {
                        currentSection.lines.push(line);
                        currentSection.endLine = index + 1;
                    }
                });

                if (currentSection) steps.push(currentSection);

            } else if (fileType === 'css') {
                // CSS parsing - group by rule blocks
                let currentRule = null;

                lines.forEach((line, index) => {
                    const trimmed = line.trim();

                    if (trimmed.includes('{') && !trimmed.startsWith('/*')) {
                        if (currentRule) steps.push(currentRule);
                        const selector = trimmed.split('{')[0].trim();
                        currentRule = {
                            title: `Styling: ${selector.substring(0, 30)}${selector.length > 30 ? '...' : ''}`,
                            type: 'style',
                            startLine: index + 1,
                            lines: [line],
                            icon: '',
                            selector: selector
                        };
                    } else if (currentRule) {
                        currentRule.lines.push(line);
                        currentRule.endLine = index + 1;
                        if (trimmed.includes('}')) {
                            steps.push(currentRule);
                            currentRule = null;
                        }
                    }
                });

            } else if (fileType === 'js' || fileType === 'javascript') {
                // JavaScript parsing - identify functions and blocks
                let currentBlock = null;

                lines.forEach((line, index) => {
                    const trimmed = line.trim();

                    if (trimmed.includes('function ') || trimmed.includes('const ') && trimmed.includes('=>')) {
                        if (currentBlock) steps.push(currentBlock);
                        const funcName = trimmed.match(/function\s+(\w+)|const\s+(\w+)/);
                        currentBlock = {
                            title: `Function: ${funcName ? (funcName[1] || funcName[2]) : 'anonymous'}`,
                            type: 'function',
                            startLine: index + 1,
                            lines: [line],
                            icon: ''
                        };
                    } else if (trimmed.startsWith('//') && !currentBlock) {
                        steps.push({
                            title: 'Code Comment',
                            type: 'comment',
                            startLine: index + 1,
                            endLine: index + 1,
                            lines: [line],
                            icon: ''
                        });
                    } else if (currentBlock) {
                        currentBlock.lines.push(line);
                        currentBlock.endLine = index + 1;
                    }
                });

                if (currentBlock) steps.push(currentBlock);
            }

            // Filter out empty steps and add step numbers
            return steps.filter(s => s.lines && s.lines.length > 0).map((step, idx) => ({
                ...step,
                number: idx + 1,
                code: step.lines.join('\n')
            }));
        }

        // Start the tutor mode
        async function startTutorMode() {
            const code = monacoEditor ? monacoEditor.getValue() : '';
            const fileType = getFileExtension(currentFile);

            if (!code || code.trim().length < 20) {
                alert('Please generate or write some code first before starting the tutor!');
                return;
            }

            // Parse code into steps
            tutorSteps = parseCodeIntoSteps(code, fileType);

            if (tutorSteps.length === 0) {
                // Create a single step for simple code
                tutorSteps = [{
                    number: 1,
                    title: 'Complete Code Overview',
                    type: 'overview',
                    startLine: 1,
                    endLine: code.split('\n').length,
                    lines: code.split('\n'),
                    code: code,
                    icon: ''
                }];
            }

            currentTutorStep = 0;
            isTutorActive = true;

            // Update UI
            document.getElementById('tutorStartBtn').innerHTML = ' Stop Tutor';
            document.getElementById('tutorStartBtn').onclick = stopTutorMode;

            // Go to first step
            await goToTutorStep(1);

            console.log(' Tutor started with', tutorSteps.length, 'steps');
            addToTutorHistory('Started tutor for ' + currentFile);
        }

        // Stop tutor mode
        function stopTutorMode() {
            isTutorActive = false;
            currentTutorStep = 0;
            clearTutorHighlight();

            // Reset UI
            document.getElementById('tutorStartBtn').innerHTML = ' Start Step-by-Step Tutor';
            document.getElementById('tutorStartBtn').onclick = startTutorMode;
            document.getElementById('tutorPrevBtn').disabled = true;
            document.getElementById('tutorNextBtn').disabled = true;

            // Reset display
            document.getElementById('tutorStepLabel').textContent = 'Step 0 of 0';
            document.getElementById('tutorProgressBar').style.width = '0%';
            document.getElementById('tutorStepTitle').textContent = 'Ready to Learn!';
            document.getElementById('tutorStepSubtitle').textContent = 'Generate code to start the tutor';

            console.log(' Tutor stopped');
        }

        // Navigate to a specific step
        async function goToTutorStep(stepNumber) {
            if (stepNumber < 1 || stepNumber > tutorSteps.length) return;

            currentTutorStep = stepNumber;
            const step = tutorSteps[stepNumber - 1];

            // Update progress
            const progress = (stepNumber / tutorSteps.length) * 100;
            document.getElementById('tutorStepLabel').textContent = `Step ${stepNumber} of ${tutorSteps.length}`;
            document.getElementById('tutorProgressBar').style.width = `${progress}%`;
            document.getElementById('tutorFileLabel').textContent = currentFile;

            // Update step card
            document.getElementById('tutorStepIcon').textContent = step.icon || '';
            document.getElementById('tutorStepTitle').textContent = step.title;
            document.getElementById('tutorStepSubtitle').textContent = `Lines ${step.startLine}-${step.endLine || step.startLine}`;

            // Highlight code in editor
            highlightTutorLines(step.startLine, step.endLine || step.startLine);

            // Update navigation buttons
            document.getElementById('tutorPrevBtn').disabled = stepNumber <= 1;
            document.getElementById('tutorNextBtn').disabled = stepNumber >= tutorSteps.length;

            // Get AI explanation for this step
            await generateStepExplanation(step);
        }

        // Generate AI explanation for a step
        async function generateStepExplanation(step) {
            // Show loading state
            document.getElementById('tutorWhatText').innerHTML = '<span class="tutor-thinking">Analyzing code...</span>';
            document.getElementById('tutorWhyText').innerHTML = '<span class="tutor-thinking">Thinking...</span>';
            document.getElementById('tutorVisualText').innerHTML = '<span class="tutor-thinking">Processing...</span>';
            document.getElementById('tutorNextText').innerHTML = '<span class="tutor-thinking">Planning...</span>';

            try {
                const response = await fetch('/api/ai/explain', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        code: step.code,
                        fileType: getFileExtension(currentFile),
                        detailed: true,
                        provider: currentAIProvider
                    })
                });

                const data = await response.json();

                if (data.success && data.explanation) {
                    const exp = data.explanation;
                    document.getElementById('tutorWhatText').textContent = exp.summary || `This section handles ${step.title.toLowerCase()}.`;
                    document.getElementById('tutorWhyText').textContent = exp.highlights?.[0] || 'This is essential for the page to work correctly.';
                    document.getElementById('tutorVisualText').textContent = exp.highlights?.[1] || 'Watch the preview to see the visual result.';
                    document.getElementById('tutorNextText').textContent = currentTutorStep < tutorSteps.length
                        ? `Next: ${tutorSteps[currentTutorStep]?.title || 'Continue learning'}`
                        : 'This is the final step! Great job!';
                } else {
                    // Fallback explanation
                    setFallbackExplanation(step);
                }
            } catch (error) {
                console.error('Tutor explanation error:', error);
                setFallbackExplanation(step);
            }
        }

        // Set fallback explanation when AI fails
        function setFallbackExplanation(step) {
            document.getElementById('tutorWhatText').textContent = `This section defines the ${step.title.toLowerCase()}.`;
            document.getElementById('tutorWhyText').textContent = 'Every part of the code contributes to the final result.';
            document.getElementById('tutorVisualText').textContent = 'This affects how your page looks or behaves.';
            document.getElementById('tutorNextText').textContent = currentTutorStep < tutorSteps.length
                ? `Next: ${tutorSteps[currentTutorStep]?.title || 'More code'}`
                : 'This is the final step!';
        }

        // Highlight lines in Monaco editor
        function highlightTutorLines(startLine, endLine) {
            if (!monacoEditor || !monaco) return;

            // Clear previous decorations
            clearTutorHighlight();

            // Add new highlight decoration
            tutorLineDecorations = monacoEditor.deltaDecorations([], [
                {
                    range: new monaco.Range(startLine, 1, endLine, 1),
                    options: {
                        isWholeLine: true,
                        className: 'tutor-line-highlight',
                        glyphMarginClassName: 'tutor-glyph'
                    }
                }
            ]);

            // Scroll to the highlighted section
            monacoEditor.revealLineInCenter(startLine);
        }

        // Clear tutor highlighting
        function clearTutorHighlight() {
            if (monacoEditor && tutorLineDecorations.length > 0) {
                tutorLineDecorations = monacoEditor.deltaDecorations(tutorLineDecorations, []);
            }
        }

        // Navigation functions
        function tutorNextStep() {
            if (currentTutorStep < tutorSteps.length) {
                addToTutorHistory(`Explained: ${tutorSteps[currentTutorStep - 1]?.title}`);
                goToTutorStep(currentTutorStep + 1);
            }
        }

        function tutorPrevStep() {
            if (currentTutorStep > 1) {
                goToTutorStep(currentTutorStep - 1);
            }
        }

        function tutorReplayStep() {
            if (currentTutorStep > 0) {
                goToTutorStep(currentTutorStep);
            }
        }

        // Speak current tutor step
        function speakTutorStep() {
            if ('speechSynthesis' in window) {
                if (window.speechSynthesis.speaking) {
                    window.speechSynthesis.cancel();
                    return;
                }

                const title = document.getElementById('tutorStepTitle').textContent;
                const what = document.getElementById('tutorWhatText').textContent;
                const why = document.getElementById('tutorWhyText').textContent;
                const visual = document.getElementById('tutorVisualText').textContent;
                const next = document.getElementById('tutorNextText').textContent;

                const textToSpeak = `${title}. What's Happening: ${what}. Why It's Needed: ${why}. Visual Change: ${visual}. What's Next: ${next}`;

                const utterance = new SpeechSynthesisUtterance(textToSpeak);
                utterance.rate = 1; // Normal speed
                utterance.pitch = 1; // Normal pitch

                // Optional: Select a better voice
                const voices = window.speechSynthesis.getVoices();
                const preferredVoice = voices.find(voice => voice.name.includes('Google US English') || voice.name.includes('Microsoft Zira') || voice.lang === 'en-US');
                if (preferredVoice) utterance.voice = preferredVoice;

                window.speechSynthesis.speak(utterance);
            } else {
                alert('Text-to-speech is not supported in this browser.');
            }
        }

        // Ask contextual question about current step
        async function askTutorQuestion(questionType) {
            if (!isTutorActive || currentTutorStep < 1) {
                alert('Start the tutor first to ask questions!');
                return;
            }

            const step = tutorSteps[currentTutorStep - 1];
            const responseArea = document.getElementById('tutorAIResponse');
            const responseText = document.getElementById('tutorAIResponseText');

            responseArea.classList.remove('hidden');
            responseText.innerHTML = '<span class="tutor-thinking">Thinking about your question...</span>';

            let question = '';
            switch (questionType) {
                case 'why':
                    question = `Explain in simple terms why this code is needed: ${step.code}`;
                    break;
                case 'remove':
                    question = `What would happen if I remove this code? ${step.code}`;
                    break;
                case 'simplify':
                    question = `Can you explain this code in a simpler way for a beginner? ${step.code}`;
                    break;
            }

            try {
                const response = await fetch('/api/ai/explain', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        code: question,
                        fileType: 'text',
                        detailed: false,
                        provider: currentAIProvider
                    })
                });

                const data = await response.json();

                if (data.success && data.explanation) {
                    responseText.textContent = data.explanation.summary || data.explanation.highlights?.[0] || 'Great question! This code is important for the overall functionality.';
                } else {
                    responseText.textContent = 'This code helps make your website work correctly. Try experimenting with it!';
                }
            } catch (error) {
                responseText.textContent = 'Could not get AI response. The code is part of your website structure.';
            }
        }

        // Add to tutor history
        function addToTutorHistory(message) {
            const historyList = document.getElementById('historyList');
            const historyItem = document.createElement('div');
            historyItem.className = 'p-2 rounded-lg bg-green-500/10 border border-green-500/20 text-xs text-green-300';
            historyItem.innerHTML = `<span class="text-gray-500">${new Date().toLocaleTimeString()}</span> ${message}`;

            // Remove "No history" message if present
            const noHistory = historyList.querySelector('p');
            if (noHistory) noHistory.remove();

            historyList.insertBefore(historyItem, historyList.firstChild);
        }

        // Language mapping - extended for more file types
        const languageMap = {
            'html': 'html',
            'css': 'css',
            'js': 'javascript',
            'jsx': 'javascript',
            'tsx': 'typescript',
            'ts': 'typescript',
            'py': 'python',
            'json': 'json',
            'md': 'markdown'
        };

        // Get file extension
        function getFileExtension(filename) {
            return filename.split('.').pop().toLowerCase();
        }

        // Get language from filename
        function getLanguage(filename) {
            const ext = getFileExtension(filename);
            return languageMap[ext] || 'html';
        }

        // ========================================
        // INTELLIGENT LANGUAGE DETECTION SYSTEM
        // ========================================

        // Detect the type of code for smart preview handling
        // Returns: 'browser-native' | 'react' | 'python' | 'unknown'
        function detectLanguageType(code, filename) {
            const ext = getFileExtension(filename);
            const codeStr = code || '';

            // Python detection
            if (ext === 'py') {
                return { type: 'python', icon: '', label: 'Python' };
            }

            // Check content for Python patterns (in case extension is missing)
            const pythonPatterns = [
                /^def\s+\w+\s*\(/m,
                /^import\s+\w+/m,
                /^from\s+\w+\s+import/m,
                /^class\s+\w+.*:/m,
                /print\s*\(/,
                /^\s{4}def\s+/m  // Python indentation style
            ];

            const pythonMatches = pythonPatterns.filter(p => p.test(codeStr)).length;
            if (pythonMatches >= 2) {
                return { type: 'python', icon: '', label: 'Python' };
            }

            // React/JSX detection
            if (ext === 'jsx' || ext === 'tsx') {
                return { type: 'react', icon: '', label: 'React/JSX' };
            }

            // Check content for React patterns
            const reactPatterns = [
                /import\s+.*\s+from\s+['"]react['"]/,
                /import\s+React/,
                /from\s+['"]react['"]/,
                /useState\s*\(/,
                /useEffect\s*\(/,
                /useContext\s*\(/,
                /useMemo\s*\(/,
                /useCallback\s*\(/,
                /useRef\s*\(/,
                /<[A-Z]\w+[\s/>]/,  // JSX component syntax
                /export\s+default\s+function\s+\w+.*\{[\s\S]*return\s*\(/,
                /ReactDOM\.render/,
                /createRoot/
            ];

            const reactMatches = reactPatterns.filter(p => p.test(codeStr)).length;
            if (reactMatches >= 2) {
                return { type: 'react', icon: '', label: 'React/JSX' };
            }

            // Vue.js detection
            if (codeStr.includes('from \'vue\'') || codeStr.includes('from "vue"') ||
                codeStr.includes('createApp') || codeStr.includes('<template>')) {
                return { type: 'vue', icon: '', label: 'Vue.js' };
            }

            // Angular detection
            if (codeStr.includes('@angular') || codeStr.includes('@Component')) {
                return { type: 'angular', icon: '', label: 'Angular' };
            }

            // TypeScript (non-React) detection
            if (ext === 'ts' && !reactPatterns.some(p => p.test(codeStr))) {
                return { type: 'typescript', icon: '', label: 'TypeScript' };
            }

            // Browser-native code (HTML, CSS, vanilla JS)
            if (['html', 'css', 'js'].includes(ext)) {
                return { type: 'browser-native', icon: '', label: ext.toUpperCase() };
            }

            // JSON
            if (ext === 'json') {
                return { type: 'json', icon: '', label: 'JSON' };
            }

            // Markdown
            if (ext === 'md') {
                return { type: 'markdown', icon: '', label: 'Markdown' };
            }

            return { type: 'unknown', icon: '', label: 'Unknown' };
        }

        // Get preview HTML for non-browser-native code types
        function getFrameworkPreviewHTML(langType) {
            const baseStyles = `
                body {
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    height: 100vh;
                    margin: 0;
                    background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #16213e 100%);
                    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
                    color: #e4e4e7;
                }
                .notice-container {
                    text-align: center;
                    padding: 48px;
                    max-width: 420px;
                    background: rgba(255, 255, 255, 0.03);
                    border-radius: 20px;
                    border: 1px solid rgba(255, 255, 255, 0.08);
                    backdrop-filter: blur(10px);
                    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
                }
                .notice-icon {
                    font-size: 64px;
                    margin-bottom: 20px;
                    filter: drop-shadow(0 4px 20px rgba(99, 102, 241, 0.4));
                }
                .notice-title {
                    font-size: 22px;
                    font-weight: 600;
                    color: #f4f4f5;
                    margin-bottom: 12px;
                }
                .notice-subtitle {
                    font-size: 14px;
                    color: #a1a1aa;
                    margin-bottom: 28px;
                    line-height: 1.6;
                }
                .instructions {
                    background: rgba(0, 0, 0, 0.3);
                    border-radius: 12px;
                    padding: 16px;
                    border: 1px solid rgba(255, 255, 255, 0.05);
                }
                .instructions-title {
                    font-size: 11px;
                    text-transform: uppercase;
                    letter-spacing: 1px;
                    color: #71717a;
                    margin-bottom: 12px;
                }
                .command {
                    display: block;
                    background: #1e1e2e;
                    color: #10b981;
                    padding: 10px 16px;
                    border-radius: 8px;
                    font-family: 'JetBrains Mono', monospace;
                    font-size: 13px;
                    margin-bottom: 8px;
                    border: 1px solid rgba(16, 185, 129, 0.2);
                }
                .command:last-child { margin-bottom: 0; }
                .badge {
                    display: inline-block;
                    padding: 4px 12px;
                    border-radius: 999px;
                    font-size: 11px;
                    font-weight: 500;
                    margin-bottom: 16px;
                }
            `;

            if (langType.type === 'react') {
                return `<!DOCTYPE html>
<html><head><meta charset="UTF-8"><style>${baseStyles}
.badge { background: rgba(97, 218, 251, 0.15); color: #61dafb; border: 1px solid rgba(97, 218, 251, 0.3); }
</style></head><body>
<div class="notice-container">
    <div class="notice-icon"></div>
    <span class="badge">React / JSX</span>
    <div class="notice-title">React Code Detected</div>
    <div class="notice-subtitle">This is React/JSX code and requires a bundler (Vite/Webpack) to run in the browser.</div>
    <div class="instructions">
        <div class="instructions-title">Run Instructions</div>
        <code class="command">npm install</code>
        <code class="command">npm run dev</code>
    </div>
</div>
</body></html>`;
            }

            if (langType.type === 'vue') {
                return `<!DOCTYPE html>
<html><head><meta charset="UTF-8"><style>${baseStyles}
.badge { background: rgba(66, 184, 131, 0.15); color: #42b883; border: 1px solid rgba(66, 184, 131, 0.3); }
</style></head><body>
<div class="notice-container">
    <div class="notice-icon"></div>
    <span class="badge">Vue.js</span>
    <div class="notice-title">Vue.js Code Detected</div>
    <div class="notice-subtitle">This is Vue.js code and requires the Vue CLI or Vite to run.</div>
    <div class="instructions">
        <div class="instructions-title">Run Instructions</div>
        <code class="command">npm install</code>
        <code class="command">npm run serve</code>
    </div>
</div>
</body></html>`;
            }

            if (langType.type === 'angular') {
                return `<!DOCTYPE html>
<html><head><meta charset="UTF-8"><style>${baseStyles}
.badge { background: rgba(221, 0, 49, 0.15); color: #dd0031; border: 1px solid rgba(221, 0, 49, 0.3); }
</style></head><body>
<div class="notice-container">
    <div class="notice-icon"></div>
    <span class="badge">Angular</span>
    <div class="notice-title">Angular Code Detected</div>
    <div class="notice-subtitle">This is Angular code and requires the Angular CLI to run.</div>
    <div class="instructions">
        <div class="instructions-title">Run Instructions</div>
        <code class="command">npm install</code>
        <code class="command">ng serve</code>
    </div>
</div>
</body></html>`;
            }

            if (langType.type === 'python') {
                return `<!DOCTYPE html>
<html><head><meta charset="UTF-8"><style>${baseStyles}
.badge { background: rgba(55, 118, 171, 0.15); color: #3776ab; border: 1px solid rgba(55, 118, 171, 0.3); }
</style></head><body>
<div class="notice-container">
    <div class="notice-icon"></div>
    <span class="badge">Python</span>
    <div class="notice-title">Python Code Detected</div>
    <div class="notice-subtitle">Python code cannot be rendered in a browser preview. Please run this code on a server (Flask/Django/FastAPI) or locally.</div>
    <div class="instructions">
        <div class="instructions-title">Run Locally</div>
        <code class="command">python filename.py</code>
        <code class="command">python -m flask run</code>
    </div>
</div>
</body></html>`;
            }

            if (langType.type === 'typescript') {
                return `<!DOCTYPE html>
<html><head><meta charset="UTF-8"><style>${baseStyles}
.badge { background: rgba(49, 120, 198, 0.15); color: #3178c6; border: 1px solid rgba(49, 120, 198, 0.3); }
</style></head><body>
<div class="notice-container">
    <div class="notice-icon"></div>
    <span class="badge">TypeScript</span>
    <div class="notice-title">TypeScript Code Detected</div>
    <div class="notice-subtitle">TypeScript requires compilation before running in the browser.</div>
    <div class="instructions">
        <div class="instructions-title">Compile & Run</div>
        <code class="command">npx tsc filename.ts</code>
        <code class="command">node filename.js</code>
    </div>
</div>
</body></html>`;
            }

            // Generic fallback for unknown code
            return `<!DOCTYPE html>
<html><head><meta charset="UTF-8"><style>${baseStyles}
.badge { background: rgba(113, 113, 122, 0.15); color: #71717a; border: 1px solid rgba(113, 113, 122, 0.3); }
</style></head><body>
<div class="notice-container">
    <div class="notice-icon">${langType.icon}</div>
    <span class="badge">${langType.label}</span>
    <div class="notice-title">${langType.label} File</div>
    <div class="notice-subtitle">This file type cannot be previewed directly in the browser. Use appropriate tools to run or view this file.</div>
</div>
</body></html>`;
        }

        // Current detected language type for display
        let currentDetectedLang = { type: 'browser-native', icon: '', label: 'HTML' };

        require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' } });

        // Current editor theme
        let currentEditorTheme = 'vs-dark';

        // Custom theme definitions
        const customThemes = {
            'dark-blue-purple': {
                base: 'vs-dark',
                inherit: true,
                rules: [
                    { token: 'comment', foreground: '6A9955', fontStyle: 'italic' },
                    { token: 'keyword', foreground: '569CD6' },
                    { token: 'string', foreground: 'CE9178' },
                    { token: 'number', foreground: 'B5CEA8' },
                    { token: 'tag', foreground: '569CD6' },
                    { token: 'attribute.name', foreground: '9CDCFE' },
                    { token: 'attribute.value', foreground: 'CE9178' },
                    { token: 'delimiter', foreground: '808080' },
                    { token: 'type', foreground: '4EC9B0' },
                    { token: 'variable', foreground: '9CDCFE' },
                    { token: 'function', foreground: 'DCDCAA' }
                ],
                colors: {
                    'editor.background': '#1e1e2e',
                    'editor.foreground': '#d4d4d4',
                    'editorLineNumber.foreground': '#858585',
                    'editorCursor.foreground': '#8b5cf6',
                    'editor.selectionBackground': '#3b82f640',
                    'editor.lineHighlightBackground': '#2a2a3e',
                    'editorIndentGuide.background': '#404040',
                    'editorIndentGuide.activeBackground': '#8b5cf6'
                }
            },
            'dark-green-cyan': {
                base: 'vs-dark',
                inherit: true,
                rules: [
                    { token: 'comment', foreground: '608B4E', fontStyle: 'italic' },
                    { token: 'keyword', foreground: '22D3EE' },
                    { token: 'string', foreground: '10B981' },
                    { token: 'number', foreground: '34D399' },
                    { token: 'tag', foreground: '22D3EE' },
                    { token: 'attribute.name', foreground: '6EE7B7' },
                    { token: 'attribute.value', foreground: '10B981' },
                    { token: 'delimiter', foreground: '6B7280' },
                    { token: 'type', foreground: '5EEAD4' },
                    { token: 'variable', foreground: '6EE7B7' },
                    { token: 'function', foreground: 'A7F3D0' }
                ],
                colors: {
                    'editor.background': '#0f1419',
                    'editor.foreground': '#e0e0e0',
                    'editorLineNumber.foreground': '#4B5563',
                    'editorCursor.foreground': '#10b981',
                    'editor.selectionBackground': '#10b98140',
                    'editor.lineHighlightBackground': '#1a2028',
                    'editorIndentGuide.background': '#374151',
                    'editorIndentGuide.activeBackground': '#10b981'
                }
            },
            'light-blue': {
                base: 'vs',
                inherit: true,
                rules: [
                    { token: 'comment', foreground: '008000', fontStyle: 'italic' },
                    { token: 'keyword', foreground: '0000FF' },
                    { token: 'string', foreground: 'A31515' },
                    { token: 'number', foreground: '098658' },
                    { token: 'tag', foreground: '800000' },
                    { token: 'attribute.name', foreground: 'FF0000' },
                    { token: 'attribute.value', foreground: '0000FF' },
                    { token: 'delimiter', foreground: '000000' },
                    { token: 'type', foreground: '267F99' },
                    { token: 'variable', foreground: '001080' },
                    { token: 'function', foreground: '795E26' }
                ],
                colors: {
                    'editor.background': '#ffffff',
                    'editor.foreground': '#000000',
                    'editorLineNumber.foreground': '#237893',
                    'editorCursor.foreground': '#3b82f6',
                    'editor.selectionBackground': '#3b82f630',
                    'editor.lineHighlightBackground': '#f0f9ff',
                    'editorIndentGuide.background': '#d1d5db',
                    'editorIndentGuide.activeBackground': '#3b82f6'
                }
            },
            'light-purple': {
                base: 'vs',
                inherit: true,
                rules: [
                    { token: 'comment', foreground: '6B7280', fontStyle: 'italic' },
                    { token: 'keyword', foreground: '7C3AED' },
                    { token: 'string', foreground: 'DB2777' },
                    { token: 'number', foreground: '059669' },
                    { token: 'tag', foreground: '7C3AED' },
                    { token: 'attribute.name', foreground: 'A855F7' },
                    { token: 'attribute.value', foreground: 'DB2777' },
                    { token: 'delimiter', foreground: '6B7280' },
                    { token: 'type', foreground: '8B5CF6' },
                    { token: 'variable', foreground: 'A855F7' },
                    { token: 'function', foreground: 'C026D3' }
                ],
                colors: {
                    'editor.background': '#faf5ff',
                    'editor.foreground': '#1f2937',
                    'editorLineNumber.foreground': '#7c3aed',
                    'editorCursor.foreground': '#8b5cf6',
                    'editor.selectionBackground': '#8b5cf630',
                    'editor.lineHighlightBackground': '#f3e8ff',
                    'editorIndentGuide.background': '#e9d5ff',
                    'editorIndentGuide.activeBackground': '#8b5cf6'
                }
            }
        };

        // Function to apply color theme
        function applyColorTheme(themeName) {
            if (!monacoEditor || !monaco) return;

            const themeId = 'custom-' + themeName;
            const themeData = customThemes[themeName];

            if (themeData) {
                // Define and apply custom theme
                monaco.editor.defineTheme(themeId, themeData);
                monaco.editor.setTheme(themeId);
                currentEditorTheme = themeId;

                // Update UI colors based on theme
                const isLight = themeName.startsWith('light');
                const codePanel = document.getElementById('codePanel');
                const openFileTabs = document.getElementById('openFileTabs');

                if (isLight) {
                    if (codePanel) codePanel.style.backgroundColor = themeData.colors['editor.background'];
                    if (openFileTabs) {
                        openFileTabs.style.backgroundColor = '#f3f4f6';
                        openFileTabs.style.borderColor = '#e5e7eb';
                    }
                } else {
                    if (codePanel) codePanel.style.backgroundColor = themeData.colors['editor.background'];
                    if (openFileTabs) {
                        openFileTabs.style.backgroundColor = '#1e1e1e';
                        openFileTabs.style.borderColor = 'rgba(255,255,255,0.05)';
                    }
                }

                console.log('Applied theme:', themeName);
            }
        }

        require(['vs/editor/editor.main'], function () {
            // Define all custom themes first
            Object.keys(customThemes).forEach(themeName => {
                monaco.editor.defineTheme('custom-' + themeName, customThemes[themeName]);
            });

            // Create Monaco editor with default dark theme
            monacoEditor = monaco.editor.create(document.getElementById('codePanel'), {
                value: projectFiles[currentFile],
                language: getLanguage(currentFile),
                theme: 'custom-dark-blue-purple',
                automaticLayout: true,
                fontSize: 14,
                lineHeight: 22,
                lineNumbers: 'on',
                minimap: { enabled: false },
                scrollBeyondLastLine: false,
                wordWrap: 'on',
                tabSize: 2,
                insertSpaces: true,
                formatOnPaste: true,
                formatOnType: true,
                suggestOnTriggerCharacters: true,
                quickSuggestions: true,
                folding: true,
                renderWhitespace: 'selection',
                bracketPairColorization: { enabled: true },
                smoothScrolling: true,
                cursorBlinking: 'smooth',
                cursorSmoothCaretAnimation: 'on'
            });

            // Set up color theme change handler
            const colorThemeSelect = document.getElementById('colorThemeSelect');
            if (colorThemeSelect) {
                colorThemeSelect.addEventListener('change', function () {
                    applyColorTheme(this.value);
                });
            }

            // Initial combined preview
            setTimeout(() => updateCombinedPreview(), 100);

            // Auto-save on change and update preview
            monacoEditor.onDidChangeModelContent(() => {
                // Save current file content
                projectFiles[currentFile] = monacoEditor.getValue();
                // Update combined preview
                updatePreviewDebounced();
            });
        });

        // Switch to a different file - VS Code behavior
        function switchFile(filename) {
            if (!projectFiles[filename]) return;

            // Save current file content before switching
            if (currentFile && monacoEditor) {
                projectFiles[currentFile] = monacoEditor.getValue();
            }

            // Update current file
            currentFile = filename;

            // Add to open tabs if not already open
            if (!openTabs.includes(filename)) {
                openTabs.push(filename);
                addFileTab(filename);
            }

            // Load new file content
            monacoEditor.setValue(projectFiles[filename]);

            // Format content
            setTimeout(formatEditorContent, 50);

            // Set language mode based on file extension
            const model = monacoEditor.getModel();
            monaco.editor.setModelLanguage(model, getLanguage(filename));

            // Update UI to show active file
            updateActiveFileUI();
        }

        // Update active file highlighting in UI
        function updateActiveFileUI() {
            // Update file tree
            document.querySelectorAll('.file-item').forEach(item => {
                if (item.dataset.file === currentFile) {
                    item.classList.add('text-white', 'bg-white/10', 'border-l-2', 'border-purple-500');
                    item.classList.remove('text-gray-400');
                } else {
                    item.classList.remove('text-white', 'bg-white/10', 'border-l-2', 'border-purple-500');
                    item.classList.add('text-gray-400');
                }
            });

            // Update file tabs
            document.querySelectorAll('.file-tab').forEach(tab => {
                if (tab.dataset.file === currentFile) {
                    tab.classList.add('text-white', 'bg-dark');
                    tab.classList.remove('text-gray-400');
                } else {
                    tab.classList.remove('text-white', 'bg-dark');
                    tab.classList.add('text-gray-400');
                }
            });
        }

        let lastValidCode = '';
        let updateTimeout = null;

        // Debounced update function (300ms delay)
        function updatePreviewDebounced() {
            clearTimeout(updateTimeout);
            updateTimeout = setTimeout(() => {
                updateCombinedPreview();
            }, 300);
        }

        // Combine all project files into a single preview
        function updateCombinedPreview() {
            const previewFrame = document.getElementById('previewFrame');
            if (!previewFrame) return;

            try {
                // Get current file content for language detection
                const currentCode = monacoEditor ? monacoEditor.getValue() : '';
                const langType = detectLanguageType(currentCode, currentFile);
                currentDetectedLang = langType;

                // Update language badge in UI if it exists
                updateLanguageBadge(langType);

                // Check if current file is non-browser-native code
                if (langType.type !== 'browser-native') {
                    // Show framework/backend message instead of trying to render
                    previewFrame.srcdoc = getFrameworkPreviewHTML(langType);
                    console.log(` ${langType.label} code detected - showing framework notice`);
                    return;
                }

                // Check if index.html exists - VS Code behavior: show blank/error if main file is deleted
                if (!projectFiles['index.html']) {
                    const emptyPreview = `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    body {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
      background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #16213e 100%);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      color: #a1a1aa;
    }
    .ready-container {
      text-align: center;
      padding: 48px;
      max-width: 380px;
    }
    .ready-icon {
      font-size: 56px;
      margin-bottom: 20px;
      filter: drop-shadow(0 4px 20px rgba(139, 92, 246, 0.4));
    }
    .ready-title {
      font-size: 20px;
      font-weight: 600;
      color: #f4f4f5;
      margin-bottom: 10px;
    }
    .ready-subtitle {
      font-size: 14px;
      color: #71717a;
      line-height: 1.6;
    }
    .tip {
      margin-top: 24px;
      padding: 12px 16px;
      background: rgba(139, 92, 246, 0.1);
      border: 1px solid rgba(139, 92, 246, 0.2);
      border-radius: 10px;
      font-size: 12px;
      color: #a78bfa;
    }
  </style>
</head>
<body>
  <div class="ready-container">
    <div class="ready-icon"></div>
    <div class="ready-title">Ready to Build</div>
    <div class="ready-subtitle">Create an index.html file or generate code with AI to see your live preview here.</div>
    <div class="tip"> Tip: Click "+ New" to create a file, or use the AI prompt to generate a complete website.</div>
  </div>
</body>
</html>`;
                    previewFrame.srcdoc = emptyPreview;
                    return;
                }

                // Build combined HTML with embedded CSS and JS
                const htmlContent = projectFiles['index.html'] || '';
                const cssContent = projectFiles['style.css'] || '';
                const jsContent = projectFiles['script.js'] || '';

                // Create combined document
                let combinedCode = `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>${cssContent}</style>
</head>
<body>
  ${extractBodyContent(htmlContent)}
  <script>${jsContent}<\/script>
</body>
</html>`;

                // Substitute relative image paths with base64 data URIs
                Object.keys(projectFiles).forEach(filename => {
                    if (filename.startsWith('images/') && projectFiles[filename].startsWith('data:')) {
                        // Replace various path formats: ./images/, images/, /images/
                        const relativePath = filename; // images/image-1.jpg
                        const dotRelativePath = './' + filename; // ./images/image-1.jpg
                        const absolutePath = '/' + filename; // /images/image-1.jpg

                        const base64Data = projectFiles[filename];

                        // Replace all path formats with base64 data URI
                        combinedCode = combinedCode.split(dotRelativePath).join(base64Data);
                        combinedCode = combinedCode.split(absolutePath).join(base64Data);
                        combinedCode = combinedCode.split(relativePath).join(base64Data);
                    }
                });

                previewFrame.srcdoc = combinedCode;
                lastValidCode = combinedCode;
            } catch (error) {
                console.log('Preview error, keeping last valid code');
                if (lastValidCode) {
                    previewFrame.srcdoc = lastValidCode;
                }
            }
        }

        // Update language detection badge in UI
        function updateLanguageBadge(langType) {
            const badge = document.getElementById('languageDetectionBadge');
            if (badge) {
                badge.innerHTML = `<span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium transition-all" style="background: rgba(139, 92, 246, 0.15); border: 1px solid rgba(139, 92, 246, 0.3); color: #a78bfa;">
                    <span>${langType.icon}</span>
                    <span>${langType.label}</span>
                </span>`;
            }
        }

        // Extract body content from HTML file
        function extractBodyContent(html) {
            if (!html) return '';
            const bodyMatch = html.match(/<body[^>]*>([\s\S]*?)<\/body>/i);
            if (bodyMatch) {
                // Remove script tags from body (we'll add them separately)
                return bodyMatch[1].replace(/<script[\s\S]*?<\/script>/gi, '');
            }
            // If no body tags, treat entire content as body
            return html.replace(/<\/?(!DOCTYPE|html|head|body)[^>]*>/gi, '')
                .replace(/<style[\s\S]*?<\/style>/gi, '')
                .replace(/<script[\s\S]*?<\/script>/gi, '')
                .replace(/<link[^>]*>/gi, '');
        }

        // Function to set editor content (for AI generation)
        function setMonacoEditorContent(content) {
            if (monacoEditor) {
                monacoEditor.setValue(content);
                setTimeout(formatEditorContent, 50);
            }
        }

        // Helper to format the current editor content
        function formatEditorContent() {
            if (monacoEditor) {
                monacoEditor.getAction('editor.action.formatDocument').run();
            }
        }

        // Alias for updateCombinedPreview (used by database integration)
        function updateLivePreview() {
            updateCombinedPreview();
        }

        // Function to get editor content
        function getMonacoEditorContent() {
            return monacoEditor ? monacoEditor.getValue() : '';
        }

        // File click event handlers
        document.addEventListener('DOMContentLoaded', function () {
            // File tree click handlers
            document.querySelectorAll('.file-item').forEach(item => {
                item.addEventListener('click', function () {
                    const filename = this.dataset.file;
                    if (filename) {
                        switchFile(filename);
                    }
                });
            });

            // File tab click handlers
            document.querySelectorAll('.file-tab').forEach(tab => {
                tab.addEventListener('click', function (e) {
                    // Ignore if clicking close button
                    if (e.target.classList.contains('close-tab')) return;

                    const filename = this.dataset.file;
                    if (filename) {
                        switchFile(filename);
                    }
                });
            });

            // Add file button handler
            document.getElementById('addFileBtn').addEventListener('click', showNewFileInput);
        });

        // Show new file input
        function showNewFileInput() {
            document.getElementById('newFileInput').classList.remove('hidden');
            const input = document.getElementById('newFileName');
            input.value = '';
            input.focus();
        }

        // Hide new file input
        function hideNewFileInput() {
            document.getElementById('newFileInput').classList.add('hidden');
            document.getElementById('newFileName').value = '';
        }

        // Create new file
        function createNewFile() {
            const filename = document.getElementById('newFileName').value.trim();
            if (!filename) return;

            // Check if file already exists
            if (projectFiles[filename]) {
                alert('File already exists!');
                return;
            }

            // Get file extension and set default content
            const ext = filename.split('.').pop().toLowerCase();
            let defaultContent = '';

            switch (ext) {
                case 'html':
                    defaultContent = `<!DOCTYPE html>\n<html>\n<head>\n  <title>${filename}</title>\n</head>\n<body>\n  \n</body>\n</html>`;
                    break;
                case 'css':
                    defaultContent = `/* ${filename} */\n\n`;
                    break;
                case 'js':
                    defaultContent = `// ${filename}\n\n`;
                    break;
                default:
                    defaultContent = '';
            }

            // Add to project files
            projectFiles[filename] = defaultContent;

            // Add to file tree
            addFileToTree(filename);

            // Add to tabs
            addFileTab(filename);

            // Switch to new file
            switchFile(filename);

            // Hide input
            hideNewFileInput();
        }

        // Add file to tree UI
        function addFileToTree(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const colorClass = ext === 'html' ? 'text-orange-400' : ext === 'css' ? 'text-blue-400' : 'text-yellow-400';

            const fileItem = document.createElement('div');
            fileItem.className = 'file-item group px-3 py-2 flex items-center justify-between cursor-pointer hover:bg-white/5 text-sm text-gray-400';
            fileItem.dataset.file = filename;
            fileItem.innerHTML = `
                <div class="flex items-center space-x-2 flex-1">
                    <div class="w-4 h-4 ${colorClass} flex items-center justify-center">
                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6zm-1 2l5 5h-5V4z"/>
                        </svg>
                    </div>
                    <span class="file-name">${filename}</span>
                </div>
                <div class="file-actions hidden group-hover:flex items-center space-x-1">
                    <button onclick="event.stopPropagation(); renameFile('${filename}')" class="p-1 hover:bg-white/10 rounded" title="Rename">
                        <svg class="w-3 h-3 text-gray-400 hover:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                        </svg>
                    </button>
                    <button onclick="event.stopPropagation(); deleteFile('${filename}')" class="p-1 hover:bg-red-500/20 rounded" title="Delete">
                        <svg class="w-3 h-3 text-gray-400 hover:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                </div>
            `;

            fileItem.addEventListener('click', () => switchFile(filename));

            // Insert before the new file input
            const newFileInput = document.getElementById('newFileInput');
            newFileInput.parentNode.insertBefore(fileItem, newFileInput);
        }

        // Delete file - VS Code behavior: immediately sync editor and preview
        function deleteFile(filename) {
            if (!confirm(`Delete "${filename}"? This cannot be undone.`)) return;

            console.log('Deleting file:', filename);

            // First, remove from projectFiles
            delete projectFiles[filename];

            // Remove from open tabs tracking BEFORE switching
            const tabIndex = openTabs.indexOf(filename);
            if (tabIndex !== -1) {
                openTabs.splice(tabIndex, 1);
            }

            // Remove unsaved changes tracking
            delete unsavedChanges[filename];

            // Remove from file tree UI
            const fileItem = document.querySelector(`.file-item[data-file="${filename}"]`);
            if (fileItem) {
                fileItem.remove();
                console.log('Removed from file tree:', filename);
            }

            // Remove from tabs UI
            const fileTab = document.querySelector(`.file-tab[data-file="${filename}"]`);
            if (fileTab) {
                fileTab.remove();
                console.log('Removed from tabs:', filename);
            }

            // If current file was deleted, switch to another file or clear editor
            if (currentFile === filename) {
                console.log('Deleted file was current file, switching...');
                const remainingFiles = Object.keys(projectFiles);

                if (remainingFiles.length > 0) {
                    // Pick next file: prefer open tabs, then any remaining file
                    let nextFile = null;

                    // Find first open tab that still exists
                    for (const tab of openTabs) {
                        if (projectFiles[tab]) {
                            nextFile = tab;
                            break;
                        }
                    }

                    // If no open tab found, use first remaining file
                    if (!nextFile) {
                        nextFile = remainingFiles[0];
                    }

                    console.log('Switching to:', nextFile);

                    // Ensure the next file is in open tabs
                    if (!openTabs.includes(nextFile)) {
                        openTabs.push(nextFile);
                        addFileTab(nextFile);
                    }

                    // Switch to the next file
                    currentFile = nextFile;
                    if (monacoEditor && projectFiles[nextFile]) {
                        monacoEditor.setValue(projectFiles[nextFile]);
                        const model = monacoEditor.getModel();
                        monaco.editor.setModelLanguage(model, getLanguage(nextFile));
                    }
                    updateActiveFileUI();
                } else {
                    // No files left - clear editor
                    console.log('No files left, clearing editor');
                    currentFile = '';
                    if (monacoEditor) {
                        monacoEditor.setValue('// No files in project');
                    }
                }
            }

            // Immediately update preview - VS Code sync behavior
            updateCombinedPreview();
            console.log('Preview updated after delete');
        }

        // Close tab without deleting file - VS Code behavior
        function closeTab(filename) {
            // Remove from open tabs
            const tabIndex = openTabs.indexOf(filename);
            if (tabIndex !== -1) {
                openTabs.splice(tabIndex, 1);
            }

            // Remove tab from UI
            const fileTab = document.querySelector(`.file-tab[data-file="${filename}"]`);
            if (fileTab) fileTab.remove();

            // If closing current file, switch to another open tab
            if (currentFile === filename) {
                if (openTabs.length > 0) {
                    // Switch to the next available open tab
                    const nextTab = openTabs[Math.max(0, tabIndex - 1)] || openTabs[0];
                    switchFile(nextTab);
                } else {
                    // No tabs open - clear editor or switch to first project file
                    const files = Object.keys(projectFiles);
                    if (files.length > 0) {
                        switchFile(files[0]);
                        openTabs.push(files[0]);
                        addFileTab(files[0]);
                    } else {
                        currentFile = '';
                        if (monacoEditor) {
                            monacoEditor.setValue('');
                        }
                    }
                }
            }
        }

        // Rename file
        function renameFile(oldFilename) {
            const fileItem = document.querySelector(`.file-item[data-file="${oldFilename}"]`);
            if (!fileItem) return;

            const nameSpan = fileItem.querySelector('.file-name');
            const originalName = nameSpan.textContent;

            // Create inline input
            const input = document.createElement('input');
            input.type = 'text';
            input.value = originalName;
            input.className = 'bg-[#1e1e1e] text-white text-sm border border-purple-500 rounded px-1 w-full focus:outline-none';

            // Replace span with input
            nameSpan.replaceWith(input);
            input.focus();
            input.select();

            let isSaving = false;

            // Handle save on blur or Enter
            function saveRename() {
                if (isSaving) return;
                isSaving = true;

                const newFilename = input.value.trim();

                // If cancelled or empty, revert
                if (!newFilename || newFilename === oldFilename) {
                    input.replaceWith(nameSpan);
                    return;
                }

                // Check if name already exists
                if (projectFiles[newFilename]) {
                    alert('A file with that name already exists!');
                    input.replaceWith(nameSpan); // Revert
                    return;
                }

                // Perform rename
                // Update projectFiles
                projectFiles[newFilename] = projectFiles[oldFilename];
                delete projectFiles[oldFilename];

                // Update file tree DOM
                fileItem.dataset.file = newFilename;
                nameSpan.textContent = newFilename;
                input.replaceWith(nameSpan);

                // Update DOM attribute for buttons
                const renameBtn = fileItem.querySelector('button[title="Rename"]');
                const deleteBtn = fileItem.querySelector('button[title="Delete"]');
                if (renameBtn) renameBtn.setAttribute('onclick', `event.stopPropagation(); renameFile('${newFilename}')`);
                if (deleteBtn) deleteBtn.setAttribute('onclick', `event.stopPropagation(); deleteFile('${newFilename}')`);

                // Update Tabs
                const fileTab = document.querySelector(`.file-tab[data-file="${oldFilename}"]`);
                if (fileTab) {
                    fileTab.dataset.file = newFilename;
                    const tabSpan = fileTab.querySelector('span');
                    if (tabSpan) tabSpan.textContent = newFilename;
                }

                // Update current file reference
                if (currentFile === oldFilename) {
                    currentFile = newFilename;
                }

                // Update editor language if extension changed
                if (monacoEditor) {
                    const model = monacoEditor.getModel();
                    monaco.editor.setModelLanguage(model, getLanguage(newFilename));
                }

                // Update preview
                updateCombinedPreview();
            }

            // Event listeners for input
            input.addEventListener('blur', saveRename);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    input.blur();
                } else if (e.key === 'Escape') {
                    input.value = oldFilename;
                    input.blur();
                }
                e.stopPropagation();
            });
            input.addEventListener('click', (e) => e.stopPropagation());
        }

        // Add file tab with proper close button handling
        function addFileTab(filename) {
            // Don't add duplicate tabs
            if (document.querySelector(`.file-tab[data-file="${filename}"]`)) return;

            const ext = filename.split('.').pop().toLowerCase();
            const bgColor = ext === 'html' ? 'bg-orange-400' : ext === 'css' ? 'bg-blue-400' : 'bg-yellow-400';

            const tab = document.createElement('div');
            tab.className = 'file-tab px-3 py-2 flex items-center space-x-2 cursor-pointer text-sm text-gray-400 hover:bg-white/5 border-r border-white/5';
            tab.dataset.file = filename;
            tab.innerHTML = `
                <div class="w-2 h-2 rounded-full ${bgColor}"></div>
                <span>${filename}</span>
                <button class="close-tab ml-1 text-gray-500 hover:text-white text-xs" title="Close"></button>
            `;

            // Click on tab to switch file
            tab.addEventListener('click', (e) => {
                if (!e.target.classList.contains('close-tab')) {
                    switchFile(filename);
                }
            });

            // Click on close button to close tab (not delete file)
            const closeBtn = tab.querySelector('.close-tab');
            if (closeBtn) {
                closeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    closeTab(filename);
                });
            }

            document.getElementById('openFileTabs').appendChild(tab);

            // Add to open tabs if not already there
            if (!openTabs.includes(filename)) {
                openTabs.push(filename);
            }
        }

        // Rebuild open file tabs UI
        function rebuildOpenFileTabs() {
            const tabsContainer = document.getElementById('openFileTabs');
            if (!tabsContainer) return;

            tabsContainer.innerHTML = '';

            openTabs.forEach(filename => {
                if (projectFiles[filename]) {
                    addFileTab(filename);
                }
            });

            updateActiveFileUI();
        }
    </script>

    <!-- Tab Switching Script -->
    <script>
        // Tab switching logic
        const tabs = {
            code: document.getElementById('codeTab'),
            preview: document.getElementById('previewTab'),
            split: document.getElementById('splitTab')
        };

        const panels = {
            code: document.getElementById('codePanelContainer'),
            preview: document.getElementById('previewPanelContainer')
        };

        function setActiveTab(tabName) {
            // Reset all tabs
            Object.values(tabs).forEach(tab => {
                tab.classList.remove('text-white', 'border-b-2', 'border-electricBlue');
                tab.classList.add('text-gray-400');
            });

            // Set active tab
            tabs[tabName].classList.remove('text-gray-400');
            tabs[tabName].classList.add('text-white', 'border-b-2', 'border-electricBlue');

            // Show/hide panels
            if (tabName === 'code') {
                panels.code.classList.remove('hidden');
                panels.preview.classList.add('hidden');
                panels.code.style.flex = '1';
            } else if (tabName === 'preview') {
                panels.code.classList.add('hidden');
                panels.preview.classList.remove('hidden');
                panels.preview.style.flex = '1';
            } else if (tabName === 'split') {
                panels.code.classList.remove('hidden');
                panels.preview.classList.remove('hidden');
                panels.code.style.flex = '1';
                panels.preview.style.flex = '1';
            }
        }

        tabs.code.addEventListener('click', () => setActiveTab('code'));
        tabs.preview.addEventListener('click', () => setActiveTab('preview'));
        tabs.split.addEventListener('click', () => setActiveTab('split'));
    </script>

    <!-- Prompt Builder Logic -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const promptForm = document.getElementById('promptForm');
            const promptInput = document.getElementById('promptInput');
            const promptResponse = document.getElementById('promptResponse');
            const promptResponseText = document.getElementById('promptResponseText');
            const codePanel = document.getElementById('codePanel');
            const previewFrame = document.getElementById('previewFrame');
            const explanationPanel = document.getElementById('explanationPanel');

            // Simple intent analyzer
            function analyzePrompt(prompt) {
                const lower = prompt.toLowerCase();

                // Color changes
                if (lower.includes('color') && lower.includes('blue')) {
                    return { type: 'color', value: 'blue', target: lower.includes('button') ? 'button' : 'heading' };
                }
                if (lower.includes('color') && lower.includes('red')) {
                    return { type: 'color', value: 'red', target: lower.includes('button') ? 'button' : 'heading' };
                }

                // Center alignment
                if (lower.includes('center')) {
                    return { type: 'align', value: 'center', target: lower.includes('heading') ? 'heading' : 'text' };
                }

                // Font size
                if (lower.includes('bigger') || lower.includes('larger') || lower.includes('increase')) {
                    return { type: 'size', value: 'increase', target: lower.includes('heading') ? 'heading' : 'text' };
                }
                if (lower.includes('smaller') || lower.includes('decrease')) {
                    return { type: 'size', value: 'decrease', target: lower.includes('heading') ? 'heading' : 'text' };
                }

                // Add elements
                if (lower.includes('add') && lower.includes('navbar')) {
                    return { type: 'add', element: 'navbar' };
                }
                if (lower.includes('add') && lower.includes('button')) {
                    return { type: 'add', element: 'button' };
                }

                return { type: 'unknown' };
            }

            // Apply code changes based on intent
            function applyChanges(intent) {
                let currentCode = getMonacoEditorContent();
                let explanation = '';
                let modified = false;

                switch (intent.type) {
                    case 'color':
                        if (intent.target === 'button') {
                            currentCode = currentCode.replace(
                                /class="([^"]*btn[^"]*)"/g,
                                `class="$1 bg-${intent.value}-500 hover:bg-${intent.value}-600"`
                            );
                            explanation = `Changed button color to ${intent.value} by updating CSS classes`;
                            modified = true;
                        } else if (intent.target === 'heading') {
                            currentCode = currentCode.replace(
                                /<h1([^>]*)>/,
                                `<h1$1 style="color: ${intent.value};">`
                            );
                            explanation = `Applied ${intent.value} color to heading using inline styles`;
                            modified = true;
                        }
                        break;

                    case 'align':
                        if (intent.target === 'heading') {
                            if (!currentCode.includes('text-center')) {
                                currentCode = currentCode.replace(
                                    /<h1 class="/,
                                    '<h1 class="text-center '
                                );
                                explanation = 'Centered heading using Tailwind text-center class';
                                modified = true;
                            }
                        }
                        break;

                    case 'size':
                        if (intent.target === 'heading') {
                            if (intent.value === 'increase') {
                                currentCode = currentCode.replace(
                                    /text-(\d+)xl/,
                                    function (match, num) {
                                        return 'text-' + (parseInt(num) + 1) + 'xl';
                                    }
                                );
                                explanation = 'Increased heading font size using larger Tailwind text class';
                                modified = true;
                            }
                        }
                        break;

                    case 'add':
                        if (intent.element === 'navbar') {
                            const navbar = `
    <!-- Navbar -->
    <nav class="bg-gray-800 p-4">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="text-white font-bold text-xl">My Website</div>
            <div class="flex space-x-4">
                <a href="#" class="text-gray-300 hover:text-white">Home</a>
                <a href="#" class="text-gray-300 hover:text-white">About</a>
                <a href="#" class="text-gray-300 hover:text-white">Contact</a>
            </div>
        </div>
    </nav>
`;
                            currentCode = currentCode.replace('<body>', '<body>' + navbar);
                            explanation = 'Added a responsive navigation bar with logo and menu links';
                            modified = true;
                        }
                        break;
                }

                if (modified) {
                    // Update code panel with Monaco Editor
                    setMonacoEditorContent(currentCode);

                    // Update preview
                    updatePreview(currentCode);

                    // Add explanation to Learning Mode
                    addExplanation(explanation, intent);

                    return { success: true, message: explanation };
                } else if (intent.type === 'unknown') {
                    return { success: false, message: 'I\'m not sure how to handle that request yet. Try: "Change button color to blue" or "Center the heading"' };
                } else {
                    return { success: false, message: 'Could not find the specified element to modify' };
                }
            }

            // Update preview iframe
            function updatePreview(code) {
                if (previewFrame) {
                    previewFrame.srcdoc = code;
                }
            }

            // Add explanation to Learning Mode panel
            function addExplanation(explanation, intent) {
                const explDiv = document.createElement('div');
                explDiv.className = 'p-4 rounded-lg bg-dark border border-white/5 mb-4 animate-fadeIn';
                explDiv.innerHTML = `
                    <h4 class="text-purple-400 font-medium mb-2"> Code Updated</h4>
                    <p class="text-gray-400 text-sm mb-2">${explanation}</p>
                    <div class="text-xs text-gray-500">
                        <strong>Modified:</strong> ${intent.target || intent.element || 'code structure'}
                    </div>
                `;
                explanationPanel.insertBefore(explDiv, explanationPanel.firstChild);
            }

            // Handle form submission - USE GEMINI AI
            promptForm.addEventListener('submit', async function (e) {
                e.preventDefault();

                const prompt = promptInput.value.trim();
                if (!prompt) return;

                // Show loading state
                promptResponseText.innerHTML = '<span class="animate-pulse"> Processing with Gemini AI...</span>';
                promptResponse.classList.remove('hidden');

                try {
                    // Check if API is available
                    if (typeof API !== 'undefined' && API.getAIStatus) {
                        const status = await API.getAIStatus();

                        if (status.configured) {
                            // Use Gemini AI to modify code
                            const currentCode = monacoEditor ? monacoEditor.getValue() : projectFiles[currentFile] || '';
                            const fileType = currentFile ? currentFile.split('.').pop() : 'html';

                            const result = await API.modifyCode(currentCode, prompt, fileType);

                            if (result.success) {
                                // Update editor with AI-modified code
                                projectFiles[currentFile] = result.code;
                                if (monacoEditor) {
                                    monacoEditor.setValue(result.code);
                                }

                                // Update preview
                                updateLivePreview();

                                // Save to database if connected
                                if (typeof saveFileToDB === 'function' && currentProjectUID) {
                                    await saveFileToDB(currentFile, result.code);
                                }

                                promptResponseText.textContent = ' Code updated successfully with AI!';

                                // Add to explanation panel
                                if (typeof addAIExplanation === 'function') {
                                    addAIExplanation('Applied change: ' + prompt, 'AI Modification');
                                }

                                // Clear input
                                promptInput.value = '';
                            } else {
                                throw new Error(result.error || 'AI modification failed');
                            }
                        } else {
                            // Fall back to local analysis if AI not configured
                            const intent = analyzePrompt(prompt);
                            const result = applyChanges(intent);
                            promptResponseText.textContent = result.message + ' (Local mode - add GEMINI_API_KEY for AI)';
                            promptInput.value = '';
                        }
                    } else {
                        // Fall back to local analysis
                        const intent = analyzePrompt(prompt);
                        const result = applyChanges(intent);
                        promptResponseText.textContent = result.message;
                        promptInput.value = '';
                    }
                } catch (error) {
                    console.error('Prompt error:', error);
                    promptResponseText.textContent = ' ' + error.message;
                }

                // Hide response after 5 seconds
                setTimeout(() => {
                    promptResponse.classList.add('hidden');
                }, 5000);
            });

            // Auto-resize textarea and handle keypress
            promptInput.addEventListener('input', function () {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });

            // Handle Enter key for submission
            promptInput.addEventListener('keydown', function (e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (this.value.trim()) {
                        promptForm.dispatchEvent(new Event('submit'));
                    }
                }
            });
        });
    </script>

    <!-- Load API Client, Backend & App -->
    <script src="js/api.js"></script>
    <script src="js/backend.js"></script>
    <script src="js/app.js"></script>

    <!-- Database Integration Script -->
    <script>
        // Current project state
        let currentProjectUID = null;
        let autoSaveTimer = null;
        const AUTO_SAVE_DELAY = 2000; // 2 seconds after last change

        // Initialize database connection and load/create project
        async function initDatabaseIntegration() {
            console.log(' Initializing database integration...');

            // Check database health
            const health = await API.checkHealth();
            console.log('Database status:', health);

            if (health.database === 'connected') {
                console.log(' Database connected');

                // Check for existing project in URL or localStorage
                const urlParams = new URLSearchParams(window.location.search);
                let projectId = urlParams.get('project') || localStorage.getItem('currentProjectUID');

                if (projectId) {
                    // Try to load existing project
                    const result = await API.getProject(projectId);
                    if (result.success && result.project) {
                        await loadProjectFromDB(result.project);
                        return;
                    }
                }

                // Create new project if none exists
                await createNewDBProject();
            } else {
                console.log(' Database not connected, using local storage only');
            }
        }

        // Load project from database
        async function loadProjectFromDB(project) {
            console.log(' Loading project:', project.name);

            currentProjectUID = project.project_uid;
            localStorage.setItem('currentProjectUID', currentProjectUID);

            // Update project name input
            const nameInput = document.getElementById('projectName');
            if (nameInput) nameInput.value = project.name;

            // Load files into editor
            if (project.files && Object.keys(project.files).length > 0) {
                // Update projectFiles global
                Object.assign(projectFiles, project.files);

                // Update Monaco editor with the current file
                if (monacoEditor && projectFiles[currentFile]) {
                    monacoEditor.setValue(projectFiles[currentFile]);
                }

                // Rebuild file tree
                rebuildFileTree();

                // Update preview
                updateLivePreview();
            }

            console.log(' Project loaded from database');
        }

        // Create new project in database
        async function createNewDBProject() {
            const projectName = document.getElementById('projectName')?.value || 'My AI Website';

            const result = await API.createProject({
                name: projectName,
                theme: 'SaaS Landing Page',
                colorTheme: 'Dark with blue & purple',
                files: projectFiles
            });

            if (result.success) {
                currentProjectUID = result.projectUID;
                localStorage.setItem('currentProjectUID', currentProjectUID);
                console.log(' New project created:', currentProjectUID);
            }
        }

        // Save current file to database
        async function saveFileToDB(filename, content) {
            if (!currentProjectUID) return;

            const result = await API.saveFile(currentProjectUID, filename, content);
            if (result.success) {
                console.log(' Saved to database:', filename);
            }
        }

        // Save all files to database
        async function saveAllFilesToDB() {
            if (!currentProjectUID) return;

            const result = await API.saveFiles(currentProjectUID, projectFiles);
            if (result.success) {
                console.log(' All files saved to database');
            }
        }

        // Auto-save function
        function triggerAutoSave() {
            if (autoSaveTimer) clearTimeout(autoSaveTimer);

            autoSaveTimer = setTimeout(async () => {
                if (currentProjectUID && monacoEditor) {
                    // Save current file content
                    projectFiles[currentFile] = monacoEditor.getValue();
                    await saveFileToDB(currentFile, projectFiles[currentFile]);
                }
            }, AUTO_SAVE_DELAY);
        }

        // Rebuild file tree UI with folder support for images
        function rebuildFileTree() {
            const fileTree = document.getElementById('fileTree');
            if (!fileTree) return;

            const newFileInput = document.getElementById('newFileInput');

            // Clear existing files (keep new file input)
            fileTree.innerHTML = '';

            // Separate files into regular files and image files
            const regularFiles = [];
            const imageFiles = [];

            Object.keys(projectFiles).forEach(filename => {
                if (filename.startsWith('images/')) {
                    imageFiles.push(filename);
                } else {
                    regularFiles.push(filename);
                }
            });

            // Helper to get file icon
            function getFileIcon(filename) {
                const ext = filename.split('.').pop().toLowerCase();
                const iconConfigs = {
                    'html': { color: 'text-orange-400', icon: '<svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L2 7v10l10 5 10-5V7L12 2z"/></svg>' },
                    'css': { color: 'text-blue-400', icon: '<svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M4 3h16v18H4V3z"/></svg>' },
                    'js': { color: 'text-yellow-400', icon: '<svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M3 3h18v18H3V3z"/></svg>' },
                    'jpg': { color: 'text-green-400', icon: '<svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>' },
                    'jpeg': { color: 'text-green-400', icon: '<svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>' },
                    'png': { color: 'text-pink-400', icon: '<svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>' },
                    'gif': { color: 'text-purple-400', icon: '<svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>' },
                    'webp': { color: 'text-cyan-400', icon: '<svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>' },
                    'svg': { color: 'text-amber-400', icon: '<svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>' }
                };
                const config = iconConfigs[ext] || { color: 'text-gray-400', icon: '<svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/></svg>' };
                return `<span class="${config.color}">${config.icon}</span>`;
            }

            // Add regular files
            regularFiles.forEach(filename => {
                const isActive = filename === currentFile;
                const div = document.createElement('div');
                div.className = 'file-item group px-3 py-2 flex items-center justify-between cursor-pointer hover:bg-white/5 text-sm ' + (isActive ? 'text-white bg-white/10 border-l-2 border-accent' : 'text-gray-400');
                div.setAttribute('data-file', filename);
                div.innerHTML = `
                    <div class="flex items-center space-x-2 flex-1">
                        ${getFileIcon(filename)}
                        <span class="file-name">${filename}</span>
                    </div>
                    <div class="file-actions hidden group-hover:flex items-center space-x-1">
                        <button onclick="event.stopPropagation(); renameFile('${filename}')" class="p-1 hover:bg-white/10 rounded" title="Rename">
                            <svg class="w-3 h-3 text-gray-400 hover:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                            </svg>
                        </button>
                        <button onclick="event.stopPropagation(); deleteFile('${filename}')" class="p-1 hover:bg-red-500/20 rounded" title="Delete">
                            <svg class="w-3 h-3 text-gray-400 hover:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                        </button>
                    </div>
                `;
                div.addEventListener('click', () => switchFile(filename));
                fileTree.appendChild(div);
            });

            // Add images folder if there are image files
            if (imageFiles.length > 0) {
                // Create folder header
                const folderDiv = document.createElement('div');
                folderDiv.className = 'images-folder';
                folderDiv.innerHTML = `
                    <div class="folder-header group px-3 py-2 flex items-center justify-between cursor-pointer hover:bg-white/5 text-sm text-gray-400" onclick="toggleImagesFolder()">
                        <div class="flex items-center space-x-2">
                            <svg id="imagesFolderChevron" class="w-3 h-3 text-gray-500 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                            <svg class="w-4 h-4 text-yellow-500" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M10 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/>
                            </svg>
                            <span>images</span>
                            <span class="text-xs text-gray-600">(${imageFiles.length})</span>
                        </div>
                    </div>
                    <div id="imagesFolderContent" class="hidden pl-4">
                        ${imageFiles.map(filepath => {
                    const filename = filepath.replace('images/', '');
                    const isImage = /\.(jpg|jpeg|png|gif|webp|svg)$/i.test(filename);
                    return `
                                <div class="file-item group px-3 py-1.5 flex items-center justify-between cursor-pointer hover:bg-white/5 text-xs text-gray-500" data-file="${filepath}">
                                    <div class="flex items-center space-x-2 flex-1">
                                        ${getFileIcon(filename)}
                                        <span class="file-name">${filename}</span>
                                    </div>
                                </div>
                            `;
                }).join('')}
                    </div>
                `;
                fileTree.appendChild(folderDiv);
            }

            // Re-add new file input
            if (newFileInput) fileTree.appendChild(newFileInput);
        }

        // Toggle images folder expand/collapse
        function toggleImagesFolder() {
            const content = document.getElementById('imagesFolderContent');
            const chevron = document.getElementById('imagesFolderChevron');
            if (content && chevron) {
                content.classList.toggle('hidden');
                chevron.style.transform = content.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(90deg)';
            }
        }

        // Hook into Monaco editor changes for auto-save
        function setupAutoSave() {
            if (monacoEditor) {
                monacoEditor.onDidChangeModelContent(() => {
                    triggerAutoSave();
                });
            }
        }

        // Initialize when Monaco is ready
        const originalRequireCallback = window.require;
        document.addEventListener('DOMContentLoaded', () => {
            // Wait for Monaco to be ready
            const checkMonaco = setInterval(() => {
                if (typeof monacoEditor !== 'undefined' && monacoEditor) {
                    clearInterval(checkMonaco);
                    setupAutoSave();
                    initDatabaseIntegration();
                    initGeminiAI();
                }
            }, 500);
        });

        // ==========================================
        // GEMINI AI INTEGRATION
        // ==========================================

        let isGenerating = false;

        async function initGeminiAI() {
            console.log(' Initializing Gemini AI integration...');

            // Check AI status
            const status = await API.getAIStatus();
            console.log('AI Status:', status);

            if (status.configured) {
                console.log(' Gemini AI is configured and ready');
            } else {
                console.log(' Gemini API key not configured. Add GEMINI_API_KEY to .env file');
            }

            // Setup event listeners
            setupAIEventListeners();
        }

        function setupAIEventListeners() {
            // Generate Website button
            const generateBtn = document.getElementById('generateBtn');
            if (generateBtn) {
                generateBtn.addEventListener('click', handleGenerateWebsite);
            }

            // URL Analysis (Analyze Website URL input)
            const urlInput = document.getElementById('urlInput');
            if (urlInput) {
                urlInput.addEventListener('keypress', async (e) => {
                    if (e.key === 'Enter' && urlInput.value.trim()) {
                        await handleAnalyzeUrl(urlInput.value.trim());
                    }
                });
            }

            // Prompt Builder form
            const promptForm = document.getElementById('promptForm');
            if (promptForm) {
                // Remove old event listener and add new one
                promptForm.removeEventListener('submit', promptForm._oldHandler);
                promptForm._oldHandler = handlePromptSubmit;
                promptForm.addEventListener('submit', handlePromptSubmit);
                // Default AI provider to Groq for reliability
                try { setAIProvider('groq'); } catch (e) { }
            }
        }

        async function handleGenerateWebsite() {
            if (isGenerating) return;

            const generateBtn = document.getElementById('generateBtn');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');

            // Get form values
            const projectName = document.getElementById('projectName')?.value || 'My AI Website';
            const colorTheme = document.getElementById('colorThemeSelect')?.value || 'dark-blue-purple';
            const urlInput = document.getElementById('urlInput')?.value || '';

            // Map color theme to description
            const themeMap = {
                'dark-blue-purple': 'Dark theme with blue and purple gradient accents',
                'dark-green-cyan': 'Dark theme with green and cyan accents',
                'light-blue': 'Light theme with blue accents',
                'light-purple': 'Light theme with purple accents'
            };

            isGenerating = true;

            // Update UI to loading state
            if (generateBtn) {
                generateBtn.disabled = true;
                generateBtn.innerHTML = `
                    <span class="flex items-center justify-center space-x-2">
                        <svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span>Generating with AI...</span>
                    </span>
                `;
            }

            if (progressBar) progressBar.style.width = '20%';
            if (progressText) {
                const providerLabel = currentAIProvider === 'groq' ? 'Groq' : 'Gemini';
                progressText.textContent = ` Connecting to ${providerLabel} AI...`;
            }

            try {
                // If URL is provided, analyze it instead
                if (urlInput.trim()) {
                    if (progressText) progressText.textContent = ' Analyzing website...';
                    if (progressBar) progressBar.style.width = '40%';

                    const result = await API.analyzeUrl(urlInput.trim(), currentAIProvider);

                    if (result.success && result.files) {
                        if (progressBar) progressBar.style.width = '80%';
                        if (progressText) progressText.textContent = ' Applying generated files...';

                        // Clear all existing files including images
                        Object.keys(projectFiles).forEach(key => {
                            delete projectFiles[key];
                        });

                        Object.keys(result.files).forEach(filename => {
                            projectFiles[filename] = result.files[filename];
                        });
                        rebuildFileTree();

                        currentFile = 'index.html';
                        if (monacoEditor && projectFiles['index.html']) {
                            let html = projectFiles['index.html'];
                            html = html.replace(/<script[^>]*cdn\.tailwindcss\.com[^>]*><\/script>/i, '');
                            if (!/href=["'][^"']*style\.css["']/i.test(html)) {
                                html = html.replace(/<head[^>]*>/i, '$&\n<link rel="stylesheet" href="style.css">');
                            }
                            projectFiles['index.html'] = html;
                            monacoEditor.setValue(html);
                            const model = monacoEditor.getModel();
                            monaco.editor.setModelLanguage(model, 'html');
                            setTimeout(formatEditorContent, 50);
                        }

                        updateActiveFileUI();
                        updateLivePreview();
                        setActiveTab('split');

                        if (currentProjectUID) {
                            await API.clearProjectFiles(currentProjectUID);
                            await saveAllFilesToDB();
                        }

                        if (progressBar) progressBar.style.width = '100%';
                        if (progressText) progressText.textContent = ` Created ${Object.keys(result.files).length} files from URL!`;

                        addAIExplanation('Generated a website inspired by the provided URL', 'URL Analysis');
                    } else {
                        throw new Error(result.error || 'Failed to analyze URL');
                    }
                } else {
                    // Regular generation - now uses multi-file generation
                    if (progressText) progressText.textContent = ' Generating website files...';
                    if (progressBar) progressBar.style.width = '40%';

                    // Use the new multi-file generation API
                    const result = await API.generateProject(
                        `Create a modern ${projectName} landing page with navbar, hero section, features, testimonials, pricing cards, and footer`,
                        projectName,
                        themeMap[colorTheme] || 'Dark theme with blue and purple accents',
                        currentAIProvider
                    );

                    if (result.success && result.files) {
                        if (progressBar) progressBar.style.width = '70%';
                        if (progressText) progressText.textContent = ' Creating project files...';

                        // Clear all existing files including images
                        Object.keys(projectFiles).forEach(key => {
                            delete projectFiles[key];
                        });

                        // Update all projectFiles with generated content
                        Object.keys(result.files).forEach(filename => {
                            projectFiles[filename] = result.files[filename];
                        });

                        // Rebuild file tree
                        rebuildFileTree();

                        // Switch to index.html
                        currentFile = 'index.html';
                        if (monacoEditor && projectFiles['index.html']) {
                            monacoEditor.setValue(projectFiles['index.html']);
                            const model = monacoEditor.getModel();
                            monaco.editor.setModelLanguage(model, 'html');
                            setTimeout(formatEditorContent, 50);
                        }

                        // Update UI
                        updateActiveFileUI();

                        // Update preview
                        updateLivePreview();

                        // Switch to split view to show both code and preview
                        setActiveTab('split');

                        // Save all files to database
                        if (currentProjectUID) {
                            await API.clearProjectFiles(currentProjectUID);
                            await saveAllFilesToDB();
                        }

                        if (progressBar) progressBar.style.width = '100%';
                        if (progressText) progressText.textContent = ` Created ${Object.keys(result.files).length} files!`;

                        addAIExplanation(
                            `Generated a complete ${projectName} website with ${Object.keys(result.files).length} files: ${Object.keys(result.files).join(', ')}`,
                            'AI Generation'
                        );

                        console.log(' Multi-file website generated');
                        console.log(' Files:', Object.keys(result.files));

                        // Automatically explain the generated code (Learning Mode)
                        explainGeneratedCode(result.files);
                    } else {
                        throw new Error(result.error || 'Generation failed');
                    }
                }
            } catch (error) {
                console.error(' Generation error:', error);
                if (progressText) progressText.textContent = ' Error: ' + error.message;

                addAIExplanation('Error: ' + error.message, 'Error');
            } finally {
                isGenerating = false;

                // Reset button
                if (generateBtn) {
                    generateBtn.disabled = false;
                    generateBtn.innerHTML = `
                        <span class="flex items-center justify-center space-x-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                            </svg>
                            <span>Generate Website</span>
                        </span>
                    `;
                }

                // Reset progress after delay
                setTimeout(() => {
                    if (progressBar) progressBar.style.width = '0%';
                    if (progressText) progressText.textContent = 'Ready to build';
                }, 3000);
            }
        }

        async function handleAnalyzeUrl(url) {
            const progressText = document.getElementById('progressText');
            const progressBar = document.getElementById('progressBar');

            if (progressText) progressText.textContent = ' Analyzing ' + url + '...';
            if (progressBar) progressBar.style.width = '30%';

            try {
                const result = await API.analyzeUrl(url, currentAIProvider);

                if (result.success && result.files) {
                    Object.keys(result.files).forEach(filename => {
                        projectFiles[filename] = result.files[filename];
                    });
                    rebuildFileTree();

                    currentFile = 'index.html';
                    if (monacoEditor && projectFiles['index.html']) {
                        let html = projectFiles['index.html'];
                        html = html.replace(/<script[^>]*cdn\.tailwindcss\.com[^>]*><\/script>/i, '');
                        if (!/href=["'][^"']*style\.css["']/i.test(html)) {
                            html = html.replace(/<head[^>]*>/i, '$&\n<link rel="stylesheet" href="style.css">');
                        }
                        projectFiles['index.html'] = html;
                        monacoEditor.setValue(html);
                        const model = monacoEditor.getModel();
                        monaco.editor.setModelLanguage(model, 'html');
                        setTimeout(formatEditorContent, 50);
                    }
                    updateActiveFileUI();
                    updateLivePreview();
                    setActiveTab('split');

                    if (currentProjectUID) {
                        await saveAllFilesToDB();
                    }

                    if (progressBar) progressBar.style.width = '100%';
                    if (progressText) progressText.textContent = ' Website generated from URL!';

                    addAIExplanation('Created a website inspired by ' + url, 'URL Analysis');
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                if (progressText) progressText.textContent = ' ' + error.message;
            }
        }

        async function handlePromptSubmit(e) {
            e.preventDefault();

            const promptInput = document.getElementById('promptInput');
            const promptResponse = document.getElementById('promptResponse');
            const promptResponseText = document.getElementById('promptResponseText');
            const aiStatusBar = document.getElementById('aiStatusBar');
            const aiStatusText = document.getElementById('aiStatusText');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');

            const prompt = promptInput?.value?.trim();
            if (!prompt) return;

            // Detect if this is a "create new website" request
            const isNewProjectRequest = detectNewProjectIntent(prompt);

            // Show loading state
            if (aiStatusBar) aiStatusBar.classList.remove('hidden');
            if (aiStatusText) aiStatusText.textContent = isNewProjectRequest ? ' Creating your website...' : ' Modifying code...';
            if (progressBar) progressBar.style.width = '20%';
            if (progressText) progressText.textContent = isNewProjectRequest ? ' Generating files...' : ' Processing...';

            // Show step progress for new projects
            if (isNewProjectRequest) {
                runStepProgress();
            }

            try {
                if (isNewProjectRequest) {
                    // === NEW PROJECT GENERATION ===
                    console.log(' Detected new project request. Generating multi-file project...');

                    const projectName = document.getElementById('projectName')?.value || 'My Website';
                    const colorTheme = document.getElementById('colorThemeSelect')?.value || 'dark-blue-purple';

                    // Map color theme
                    const themeMap = {
                        'dark-blue-purple': 'Modern dark theme with blue and purple gradient accents',
                        'dark-green-cyan': 'Modern dark theme with green and cyan accents',
                        'light-blue': 'Clean light theme with blue accents',
                        'light-purple': 'Clean light theme with purple and pink accents'
                    };

                    if (progressBar) progressBar.style.width = '40%';
                    if (aiStatusText) aiStatusText.textContent = ' Crafting HTML, CSS & JS files...';

                    // Call the new generateProject API
                    const result = await API.generateProject(
                        prompt,
                        projectName,
                        themeMap[colorTheme] || colorTheme,
                        currentAIProvider
                    );

                    if (result.success && result.files) {
                        if (progressBar) progressBar.style.width = '70%';
                        if (aiStatusText) aiStatusText.textContent = ' Applying generated files...';

                        // Update projectFiles with generated content
                        Object.keys(result.files).forEach(filename => {
                            projectFiles[filename] = result.files[filename];
                        });

                        // Rebuild the file tree to show any new files
                        rebuildFileTree();

                        // Switch to index.html and update editor
                        currentFile = 'index.html';
                        if (monacoEditor && projectFiles['index.html']) {
                            monacoEditor.setValue(projectFiles['index.html']);
                            const model = monacoEditor.getModel();
                            monaco.editor.setModelLanguage(model, 'html');
                        }

                        // Update active file UI
                        updateActiveFileUI();

                        // Update the live preview
                        updateLivePreview();

                        // Switch to preview tab to show the result
                        setActiveTab('split');

                        // Save all files to database
                        if (currentProjectUID) {
                            await API.clearProjectFiles(currentProjectUID);
                            await saveAllFilesToDB();
                        }

                        if (progressBar) progressBar.style.width = '100%';
                        if (progressText) progressText.textContent = ` Created ${result.filesCount || Object.keys(result.files).length} files!`;

                        // Show success
                        if (promptResponseText) {
                            promptResponseText.textContent = ` Website created! Generated: ${Object.keys(result.files).join(', ')}`;
                        }
                        if (promptResponse) promptResponse.classList.remove('hidden');

                        addAIExplanation(
                            `Created a complete website with ${Object.keys(result.files).length} files (${Object.keys(result.files).join(', ')}) based on: "${prompt}"`,
                            'AI Generation'
                        );

                        // Clear input
                        if (promptInput) promptInput.value = '';

                        console.log(' Multi-file project generated successfully!');
                        console.log(' Files:', Object.keys(result.files));

                        // Automatically explain the generated code (Learning Mode)
                        explainGeneratedCode(result.files);

                        // Complete step progress animation
                        completeStepProgress();

                    } else {
                        throw new Error(result.error || 'Failed to generate project');
                    }

                } else {
                    // === MODIFY EXISTING CODE ===
                    console.log(' Modifying existing code...');

                    if (progressBar) progressBar.style.width = '40%';

                    const currentCode = monacoEditor?.getValue() || projectFiles[currentFile] || '';
                    const fileType = currentFile.split('.').pop();

                    const result = await API.modifyCode(currentCode, prompt, fileType, currentAIProvider);

                    if (result.success) {
                        // Update editor and project files
                        projectFiles[currentFile] = result.code;
                        if (monacoEditor) {
                            monacoEditor.setValue(result.code);
                            setTimeout(formatEditorContent, 50);
                        }

                        // Update preview
                        updateLivePreview();

                        // Save to database
                        if (currentProjectUID) {
                            await saveFileToDB(currentFile, result.code);
                        }

                        if (progressBar) progressBar.style.width = '100%';
                        if (progressText) progressText.textContent = ' Code updated!';

                        if (promptResponseText) {
                            promptResponseText.textContent = ' Code updated successfully!';
                        }
                        if (promptResponse) promptResponse.classList.remove('hidden');

                        addAIExplanation('Modified code: ' + prompt, 'AI Modification');

                        // Clear input
                        if (promptInput) promptInput.value = '';
                    } else {
                        throw new Error(result.error || 'Modification failed');
                    }
                }

            } catch (error) {
                console.error(' Prompt error:', error);
                if (promptResponseText) {
                    promptResponseText.textContent = ' ' + error.message;
                }
                if (promptResponse) promptResponse.classList.remove('hidden');
                if (progressText) progressText.textContent = ' Error occurred';
            } finally {
                // Hide status bar
                if (aiStatusBar) aiStatusBar.classList.add('hidden');

                // Reset progress after delay
                setTimeout(() => {
                    if (progressBar) progressBar.style.width = '0%';
                    if (progressText) progressText.textContent = 'Ready to build';
                }, 3000);
            }

            // Hide response after delay
            setTimeout(() => {
                if (promptResponse) promptResponse.classList.add('hidden');
            }, 5000);
        }

        // Detect if the prompt is asking for a new website/project creation
        function detectNewProjectIntent(prompt) {
            const lowerPrompt = prompt.toLowerCase();

            // Keywords that indicate creating something new
            const createKeywords = [
                'create', 'make', 'build', 'generate', 'design', 'develop',
                'new website', 'new page', 'new project', 'new site',
                'landing page', 'portfolio', 'blog', 'e-commerce', 'ecommerce',
                'dashboard', 'admin panel', 'contact page', 'about page',
                'homepage', 'home page', 'startup', 'saas', 'app',
                'restaurant', 'agency', 'corporate', 'personal', 'business',
                'store', 'shop', 'marketplace', 'social', 'forum',
                'website for', 'page for', 'site for', 'web app'
            ];

            // Keywords that indicate modifying existing code
            const modifyKeywords = [
                'change', 'modify', 'update', 'edit', 'fix', 'add to',
                'remove', 'delete', 'replace', 'improve', 'make the',
                'change the', 'update the', 'fix the', 'add a', 'add an',
                'move', 'adjust', 'tweak', 'alter'
            ];

            // Check for creation intent
            const hasCreateIntent = createKeywords.some(keyword => lowerPrompt.includes(keyword));
            const hasModifyIntent = modifyKeywords.some(keyword => lowerPrompt.includes(keyword));

            // If has strong create intent and no strong modify intent, or prompt is long and descriptive
            if (hasCreateIntent && !hasModifyIntent) {
                return true;
            }

            // If prompt describes a complete website concept (long and detailed)
            if (lowerPrompt.length > 100 && hasCreateIntent) {
                return true;
            }

            // Default to modification for short prompts or when modify intent is detected
            return false;
        }

        function addAIExplanation(message, type = 'AI') {
            const explanationPanel = document.getElementById('explanationPanel');
            if (!explanationPanel) return;

            const colorMap = {
                'AI Generation': 'text-green-400',
                'AI Modification': 'text-purple-400',
                'URL Analysis': 'text-blue-400',
                'Code Explanation': 'text-cyan-400',
                'Error': 'text-red-400'
            };

            const iconMap = {
                'AI Generation': '',
                'AI Modification': '',
                'URL Analysis': '',
                'Code Explanation': '',
                'Error': ''
            };

            const explDiv = document.createElement('div');
            explDiv.className = 'p-4 rounded-lg bg-dark border border-white/5 mb-4 animate-fadeIn';
            explDiv.innerHTML = `
                <h4 class="${colorMap[type] || 'text-electricBlue'} font-medium mb-2">${iconMap[type] || ''} ${type}</h4>
                <p class="text-gray-400 text-sm">${message}</p>
                <div class="text-xs text-gray-500 mt-2">${new Date().toLocaleTimeString()}</div>
            `;

            // Insert at the beginning
            if (explanationPanel.firstChild) {
                explanationPanel.insertBefore(explDiv, explanationPanel.firstChild);
            } else {
                explanationPanel.appendChild(explDiv);
            }
        }

        // Add detailed code explanation to Learning Mode panel
        function addDetailedExplanation(explanation, fileType = 'code') {
            const explanationPanel = document.getElementById('explanationPanel');
            if (!explanationPanel) return;

            const explDiv = document.createElement('div');
            explDiv.className = 'p-4 rounded-lg bg-gradient-to-br from-cyan-500/10 to-blue-500/10 border border-cyan-500/20 mb-4 animate-fadeIn';

            let htmlContent = `
                <div class="flex items-center space-x-2 mb-3">
                    <div class="w-6 h-6 rounded-lg bg-cyan-500/20 flex items-center justify-center">
                        <span class="text-sm"></span>
                    </div>
                    <h4 class="text-cyan-400 font-medium">Code Explanation - ${fileType.toUpperCase()}</h4>
                </div>
            `;

            // Summary
            if (explanation.summary) {
                htmlContent += `
                    <div class="mb-4 p-3 rounded-lg bg-white/5">
                        <p class="text-white text-sm font-medium mb-1"> Summary</p>
                        <p class="text-gray-300 text-sm">${explanation.summary}</p>
                    </div>
                `;
            }

            // Sections (for detailed explanations)
            if (explanation.sections && explanation.sections.length > 0) {
                htmlContent += `<div class="space-y-3 mb-4">`;
                explanation.sections.forEach((section, idx) => {
                    htmlContent += `
                        <div class="p-3 rounded-lg bg-white/5 border-l-2 border-purple-500">
                            <p class="text-purple-300 text-sm font-medium">${section.title}</p>
                            ${section.lines ? `<p class="text-gray-500 text-xs mb-1">Lines: ${section.lines}</p>` : ''}
                            <p class="text-gray-400 text-sm mt-1">${section.explanation}</p>
                            ${section.concepts && section.concepts.length > 0 ? `
                                <div class="flex flex-wrap gap-1 mt-2">
                                    ${section.concepts.map(c => `<span class="px-2 py-0.5 rounded-full bg-purple-500/20 text-purple-300 text-xs">${c}</span>`).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                htmlContent += `</div>`;
            }

            // Highlights (for quick explanations)
            if (explanation.highlights && explanation.highlights.length > 0) {
                htmlContent += `
                    <div class="mb-3">
                        <p class="text-green-400 text-sm font-medium mb-2"> Key Highlights</p>
                        <ul class="space-y-1">
                            ${explanation.highlights.map(h => `<li class="text-gray-400 text-sm flex items-start"><span class="text-green-400 mr-2"></span>${h}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            // Key Takeaways
            if (explanation.keyTakeaways && explanation.keyTakeaways.length > 0) {
                htmlContent += `
                    <div class="mb-3">
                        <p class="text-blue-400 text-sm font-medium mb-2"> Key Takeaways</p>
                        <ul class="space-y-1">
                            ${explanation.keyTakeaways.map(t => `<li class="text-gray-400 text-sm flex items-start"><span class="text-blue-400 mr-2"></span>${t}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            // Tips
            if (explanation.tips && explanation.tips.length > 0) {
                htmlContent += `
                    <div class="p-3 rounded-lg bg-yellow-500/10 border border-yellow-500/20">
                        <p class="text-yellow-400 text-sm font-medium mb-2"> Pro Tips</p>
                        <ul class="space-y-1">
                            ${explanation.tips.map(t => `<li class="text-gray-400 text-sm">${t}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            // Learn More
            if (explanation.learnMore && explanation.learnMore.length > 0) {
                htmlContent += `
                    <div class="mt-3">
                        <p class="text-gray-500 text-xs font-medium mb-1"> Learn More About:</p>
                        <div class="flex flex-wrap gap-1">
                            ${explanation.learnMore.map(topic => `<span class="px-2 py-0.5 rounded-full bg-white/10 text-gray-400 text-xs">${topic}</span>`).join('')}
                        </div>
                    </div>
                `;
            }

            htmlContent += `<div class="text-xs text-gray-500 mt-3">${new Date().toLocaleTimeString()}</div>`;

            explDiv.innerHTML = htmlContent;

            // Insert at the beginning
            if (explanationPanel.firstChild) {
                explanationPanel.insertBefore(explDiv, explanationPanel.firstChild);
            } else {
                explanationPanel.appendChild(explDiv);
            }
        }

        // Automatically explain generated code
        async function explainGeneratedCode(files) {
            if (!files || Object.keys(files).length === 0) return;

            const explanationPanel = document.getElementById('explanationPanel');
            if (!explanationPanel) return;

            // Add loading indicator
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'explanationLoading';
            loadingDiv.className = 'p-4 rounded-lg bg-cyan-500/10 border border-cyan-500/20 mb-4';
            loadingDiv.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="animate-spin w-5 h-5 border-2 border-cyan-500 border-t-transparent rounded-full"></div>
                    <span class="text-cyan-400 text-sm">Generating code explanations...</span>
                </div>
            `;
            if (explanationPanel.firstChild) {
                explanationPanel.insertBefore(loadingDiv, explanationPanel.firstChild);
            } else {
                explanationPanel.appendChild(loadingDiv);
            }

            try {
                // Explain each file
                for (const [filename, code] of Object.entries(files)) {
                    const fileType = filename.split('.').pop();

                    // Get detailed explanation for the file
                    const result = await API.explainCode(code, fileType, true, currentAIProvider);

                    if (result.success && result.explanation) {
                        addDetailedExplanation(result.explanation, filename);
                    }
                }

                // Remove loading indicator
                const loading = document.getElementById('explanationLoading');
                if (loading) loading.remove();

            } catch (error) {
                console.error('Explanation error:', error);

                // Remove loading indicator
                const loading = document.getElementById('explanationLoading');
                if (loading) loading.remove();

                addAIExplanation('Could not generate explanations: ' + error.message, 'Error');
            }
        }

        // Execute quick action (add component to existing code)
        async function executeQuickAction(action) {
            const promptInput = document.getElementById('promptInput');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const aiStatusBar = document.getElementById('aiStatusBar');
            const aiStatusText = document.getElementById('aiStatusText');

            // Show loading
            if (aiStatusBar) aiStatusBar.classList.remove('hidden');
            if (aiStatusText) aiStatusText.textContent = ' Adding component...';
            if (progressBar) progressBar.style.width = '30%';
            if (progressText) progressText.textContent = ' ' + action;

            try {
                // Get current code
                const currentCode = monacoEditor?.getValue() || projectFiles[currentFile] || '';
                const fileType = currentFile.split('.').pop();

                if (progressBar) progressBar.style.width = '60%';

                // Use AI to modify the code
                const result = await API.modifyCode(currentCode, action, fileType);

                if (result.success) {
                    // Update editor
                    projectFiles[currentFile] = result.code;
                    if (monacoEditor) {
                        monacoEditor.setValue(result.code);
                        setTimeout(formatEditorContent, 50);
                    }

                    // Update preview
                    updateLivePreview();

                    // Save to database
                    if (currentProjectUID) {
                        await saveFileToDB(currentFile, result.code);
                    }

                    if (progressBar) progressBar.style.width = '100%';
                    if (progressText) progressText.textContent = ' Component added!';

                    addAIExplanation('Added: ' + action, 'AI Modification');
                } else {
                    throw new Error(result.error || 'Failed to add component');
                }
            } catch (error) {
                console.error('Quick action error:', error);
                if (progressText) progressText.textContent = ' Error: ' + error.message;
            } finally {
                if (aiStatusBar) aiStatusBar.classList.add('hidden');

                setTimeout(() => {
                    if (progressBar) progressBar.style.width = '0%';
                    if (progressText) progressText.textContent = 'Ready to build';
                }, 3000);
            }
        }

        // Generate template - creates a complete new website from template type
        async function generateTemplate(templateType) {
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const aiStatusBar = document.getElementById('aiStatusBar');
            const aiStatusText = document.getElementById('aiStatusText');
            const projectNameInput = document.getElementById('projectName');
            const colorThemeSelect = document.getElementById('colorThemeSelect');

            const templatePrompts = {
                'portfolio': 'Create a personal portfolio website with hero section, about me, skills, projects gallery, and contact form. Make it elegant and professional.',
                'saas': 'Create a SaaS landing page with hero, features, pricing plans, testimonials, FAQ, and CTA. Make it modern and conversion-focused.',
                'ecommerce': 'Create an e-commerce homepage with hero banner, featured products, categories, newsletter signup, and footer. Make it clean and shoppable.',
                'blog': 'Create a blog homepage with featured post, article grid, categories sidebar, newsletter signup, and footer. Make it readable and engaging.'
            };

            const prompt = templatePrompts[templateType] || templatePrompts['saas'];
            const projectName = projectNameInput?.value || templateType.charAt(0).toUpperCase() + templateType.slice(1) + ' Website';
            const colorTheme = colorThemeSelect?.value || 'dark-blue-purple';

            // Map color theme
            const themeMap = {
                'dark-blue-purple': 'Modern dark theme with blue and purple gradient accents',
                'dark-green-cyan': 'Modern dark theme with green and cyan accents',
                'light-blue': 'Clean light theme with blue accents',
                'light-purple': 'Clean light theme with purple and pink accents'
            };

            // Show step progress animation
            runStepProgress();

            // Show loading in header
            if (progressBar) progressBar.style.width = '20%';
            if (progressText) progressText.innerHTML = '<span class="animate-pulse"> Generating template...</span>';

            try {
                if (progressBar) progressBar.style.width = '40%';

                // Use the new multi-file generation API
                const result = await API.generateProject(
                    prompt,
                    projectName,
                    themeMap[colorTheme] || colorTheme,
                    currentAIProvider
                );

                if (result.success && result.files) {
                    if (progressBar) progressBar.style.width = '70%';

                    // Clear all existing files including images
                    Object.keys(projectFiles).forEach(key => {
                        delete projectFiles[key];
                    });

                    // Update projectFiles
                    Object.keys(result.files).forEach(filename => {
                        projectFiles[filename] = result.files[filename];
                    });

                    // Rebuild file tree
                    rebuildFileTree();

                    // Switch to index.html
                    currentFile = 'index.html';
                    if (monacoEditor && projectFiles['index.html']) {
                        monacoEditor.setValue(projectFiles['index.html']);
                        const model = monacoEditor.getModel();
                        monaco.editor.setModelLanguage(model, 'html');
                        setTimeout(formatEditorContent, 50);
                    }

                    // Update UI
                    updateActiveFileUI();

                    // Update preview
                    updateLivePreview();

                    // Switch to split view
                    setActiveTab('split');

                    // Save to database
                    if (currentProjectUID) {
                        await API.clearProjectFiles(currentProjectUID);
                        await saveAllFilesToDB();
                    }

                    if (progressBar) progressBar.style.width = '100%';
                    if (progressText) progressText.innerHTML = `<span class="text-cyan-400"> ${templateType.charAt(0).toUpperCase() + templateType.slice(1)} template created!</span>`;

                    // Complete step progress animation
                    completeStepProgress();

                    addAIExplanation(
                        `Created ${templateType} website with ${Object.keys(result.files).length} files: ${Object.keys(result.files).join(', ')}`,
                        'AI Generation'
                    );

                    console.log(' Template generated:', templateType);
                    console.log(' Files:', Object.keys(result.files));

                    // Automatically explain the generated code (Learning Mode)
                    explainGeneratedCode(result.files);
                } else {
                    throw new Error(result.error || 'Template generation failed');
                }

            } catch (error) {
                console.error('Template generation error:', error);
                if (progressText) progressText.innerHTML = '<span class="text-red-400"> Error: ' + error.message + '</span>';
                hideStepProgress();
                addAIExplanation('Error: ' + error.message, 'Error');
            } finally {
                if (aiStatusBar) aiStatusBar.classList.add('hidden');

                setTimeout(() => {
                    if (progressBar) progressBar.style.width = '0%';
                    if (progressText) progressText.innerHTML = '<span class="text-gray-500">Ready to build</span>';
                }, 3000);
            }
        }

        // Open Project - Import files from local system
        async function openProject() {
            try {
                // Create file input for selecting files
                const input = document.createElement('input');
                input.type = 'file';
                input.multiple = true;
                input.accept = '.html,.css,.js,.json,.txt,.md';

                input.onchange = async (e) => {
                    const files = e.target.files;
                    if (!files || files.length === 0) return;

                    const progressText = document.getElementById('progressText');
                    if (progressText) progressText.textContent = ' Loading files...';

                    console.log('Opening project files:', files.length);

                    // Load all files into projectFiles
                    for (const file of files) {
                        const content = await file.text();
                        projectFiles[file.name] = content;
                        console.log('Loaded file:', file.name, 'Length:', content.length);
                    }

                    // Clear and rebuild open tabs
                    openTabs = [];
                    const loadedFileNames = Array.from(files).map(f => f.name);

                    // Add all loaded files to open tabs
                    loadedFileNames.forEach(filename => {
                        if (!openTabs.includes(filename)) {
                            openTabs.push(filename);
                        }
                    });

                    // Rebuild file tree
                    rebuildFileTree();

                    // Rebuild tabs UI
                    rebuildOpenFileTabs();

                    // Load the first file into editor
                    const firstFile = loadedFileNames[0] || Object.keys(projectFiles)[0];
                    if (firstFile && projectFiles[firstFile]) {
                        currentFile = firstFile;
                        console.log('Setting current file to:', firstFile);

                        if (monacoEditor) {
                            monacoEditor.setValue(projectFiles[firstFile]);
                            const ext = firstFile.split('.').pop();
                            const langMap = { html: 'html', css: 'css', js: 'javascript', json: 'json', md: 'markdown' };
                            monaco.editor.setModelLanguage(monacoEditor.getModel(), langMap[ext] || 'plaintext');
                            setTimeout(formatEditorContent, 50);
                            console.log('Editor content set for:', firstFile);
                        }
                        updateActiveFileUI();
                    }

                    // Update preview
                    updateLivePreview();

                    if (progressText) progressText.textContent = ` Loaded ${files.length} file(s)`;

                    addAIExplanation(`Opened ${files.length} file(s): ${loadedFileNames.join(', ')}`, 'AI Modification');

                    setTimeout(() => {
                        if (progressText) progressText.textContent = 'Ready to build';
                    }, 3000);
                };

                input.click();
            } catch (error) {
                console.error('Open project error:', error);
                alert('Failed to open files: ' + error.message);
            }
        }

        // Save Project - Download all files as ZIP
        async function saveProject() {
            const progressText = document.getElementById('progressText');
            const progressBar = document.getElementById('progressBar');

            try {
                if (progressText) progressText.textContent = ' Saving project...';
                if (progressBar) progressBar.style.width = '30%';

                const projectName = document.getElementById('projectName')?.value || 'my-website';
                const safeName = projectName.toLowerCase().replace(/[^a-z0-9]/g, '-');

                // Check if JSZip is available, if not we'll download individual files
                if (typeof JSZip !== 'undefined') {
                    // Create ZIP file
                    const zip = new JSZip();

                    Object.entries(projectFiles).forEach(([filename, content]) => {
                        zip.file(filename, content);
                    });

                    if (progressBar) progressBar.style.width = '70%';

                    const blob = await zip.generateAsync({ type: 'blob' });
                    const url = URL.createObjectURL(blob);

                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${safeName}.zip`;
                    a.click();

                    URL.revokeObjectURL(url);

                    if (progressBar) progressBar.style.width = '100%';
                    if (progressText) progressText.textContent = ' Project saved as ZIP!';
                } else {
                    // Download files individually
                    if (progressBar) progressBar.style.width = '50%';

                    Object.entries(projectFiles).forEach(([filename, content]) => {
                        const blob = new Blob([content], { type: 'text/plain' });
                        const url = URL.createObjectURL(blob);

                        const a = document.createElement('a');
                        a.href = url;
                        a.download = filename;
                        a.click();

                        URL.revokeObjectURL(url);
                    });

                    if (progressBar) progressBar.style.width = '100%';
                    if (progressText) progressText.textContent = ` Downloaded ${Object.keys(projectFiles).length} files!`;
                }

                addAIExplanation(`Saved project "${projectName}" with ${Object.keys(projectFiles).length} files`, 'AI Modification');

            } catch (error) {
                console.error('Save project error:', error);
                if (progressText) progressText.textContent = ' Save failed: ' + error.message;
            } finally {
                setTimeout(() => {
                    if (progressBar) progressBar.style.width = '0%';
                    if (progressText) progressText.textContent = 'Ready to build';
                }, 3000);
            }
        }

        // Step Progress Functions
        function showStepProgress() {
            const simpleProgress = document.getElementById('simpleProgress');
            const stepProgress = document.getElementById('stepProgress');
            if (simpleProgress) simpleProgress.classList.add('hidden');
            if (stepProgress) stepProgress.classList.remove('hidden');
            resetStepProgress();
        }

        function hideStepProgress() {
            const simpleProgress = document.getElementById('simpleProgress');
            const stepProgress = document.getElementById('stepProgress');
            if (simpleProgress) simpleProgress.classList.remove('hidden');
            if (stepProgress) stepProgress.classList.add('hidden');
        }

        function updateStep(stepNumber, status = 'active') {
            const icon = document.getElementById(`step${stepNumber}Icon`);
            const title = document.getElementById(`step${stepNumber}Title`);

            if (!icon || !title) return;

            // Reset icon content first
            if (status === 'pending') {
                icon.className = 'w-10 h-10 rounded-full bg-[#1a2332] border-2 border-gray-700 flex items-center justify-center transition-all duration-300';
                icon.innerHTML = `<span class="text-gray-500 text-sm font-medium">${stepNumber}</span>`;
                title.className = 'text-gray-400 font-semibold text-sm tracking-wide';
            } else if (status === 'active') {
                icon.className = 'w-10 h-10 rounded-full bg-cyan-500/20 border-2 border-cyan-400 flex items-center justify-center transition-all duration-300';
                icon.innerHTML = `<svg class="w-5 h-5 text-cyan-400 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
                title.className = 'text-cyan-400 font-semibold text-sm tracking-wide';
            } else if (status === 'complete') {
                icon.className = 'w-10 h-10 rounded-full bg-cyan-500 border-2 border-cyan-400 flex items-center justify-center transition-all duration-300 shadow-lg shadow-cyan-500/30';
                icon.innerHTML = `<svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>`;
                title.className = 'text-cyan-400 font-semibold text-sm tracking-wide';
            }
        }

        function resetStepProgress() {
            for (let i = 1; i <= 4; i++) {
                updateStep(i, 'pending');
            }
        }

        // Animated step progress for generation
        async function runStepProgress() {
            showStepProgress();

            // Step 1: Loading
            updateStep(1, 'active');
            await new Promise(r => setTimeout(r, 800));
            updateStep(1, 'complete');

            // Step 2: Analyzing
            updateStep(2, 'active');
            await new Promise(r => setTimeout(r, 1200));
            updateStep(2, 'complete');

            // Step 3: Generating (this takes longest)
            updateStep(3, 'active');
        }

        function completeStepProgress() {
            updateStep(3, 'complete');
            updateStep(4, 'active');

            setTimeout(() => {
                updateStep(4, 'complete');
                setTimeout(() => {
                    hideStepProgress();
                }, 1500);
            }, 1000);
        }

        // Resizable Sidebar Logic
        const rightResizer = document.getElementById('rightResizer');
        const rightSidebar = document.getElementById('rightSidebar');
        let isResizingRight = false;

        if (rightResizer && rightSidebar) {
            rightResizer.addEventListener('mousedown', (e) => {
                e.preventDefault();
                isResizingRight = true;
                document.addEventListener('mousemove', resizeRightSidebar);
                document.addEventListener('mouseup', stopResizeRightSidebar);
                document.body.style.cursor = 'col-resize';
                rightResizer.classList.add('bg-electricBlue');
            });
        }

        function resizeRightSidebar(e) {
            if (!isResizingRight) return;
            const newWidth = window.innerWidth - e.clientX;
            if (newWidth >= 200 && newWidth <= 800) {
                rightSidebar.style.width = `${newWidth}px`;
            }
        }

        function stopResizeRightSidebar() {
            isResizingRight = false;
            document.removeEventListener('mousemove', resizeRightSidebar);
            document.removeEventListener('mouseup', stopResizeRightSidebar);
            document.body.style.cursor = 'default';
            rightResizer.classList.remove('bg-electricBlue');
        }
    </script>

</body>

</html>